<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>hmclearn package:  Logistic Mixed Effects Regression Example • hmclearn</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="hmclearn package:  Logistic Mixed Effects Regression Example">
<meta property="og:description" content="hmclearn">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hmclearn</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/linear_mixed_effects_hmclearn.html">hmclearn package:  Linear Mixed Effects Regression Example</a>
    </li>
    <li>
      <a href="../articles/linear_regression_hmclearn.html">hmclearn package:  Linear Regression Example</a>
    </li>
    <li>
      <a href="../articles/logistic_mixed_effects_hmclearn.html">hmclearn package:  Logistic Mixed Effects Regression Example</a>
    </li>
    <li>
      <a href="../articles/logistic_regression_hmclearn.html">hmclearn:  Logistic Regression Example</a>
    </li>
    <li>
      <a href="../articles/poisson_regression_hmclearn.html">hmclearn:  Poisson Regression Example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>hmclearn package: Logistic Mixed Effects Regression Example</h1>
                        <h4 class="author">Samuel Thomas</h4>
            
            <h4 class="date">2020-05-25</h4>
      
      
      <div class="hidden name"><code>logistic_mixed_effects_hmclearn.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette demonstrates fitting a Logistic mixed effects regression model via Hamiltonian Monte Carlo (HMC) using the <strong>hmclearn</strong> package.</p>
<p>For a mixed effects model with binary response, we let</p>
<p><span class="math display">\[
p = Pr(Y = 1 | X, Z) = [1 + e^{-X\beta-Zu}]^{-1}
\]</span> or</p>
<p><span class="math display">\[
\begin{aligned}
\text{logit}[P(y = 1 | u)] &amp;= X\beta + Zu \\
u &amp;\sim N(0, G)
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">hmclearn</span>)</pre></body></html></div>
</div>
<div id="logistic-mixed-effects-model-example-data" class="section level1">
<h1 class="hasAnchor">
<a href="#logistic-mixed-effects-model-example-data" class="anchor"></a>Logistic Mixed Effects Model Example Data</h1>
<p>The user must define provide the design matrix directly for use in <strong>hmclearn</strong>. Our first step is to load the data and store the fixed effect design matrix <span class="math inline">\(X\)</span>, random effects design matrix <span class="math inline">\(Z\)</span>, and dependent variable vector <span class="math inline">\(y\)</span>.</p>
<p>We load drug Contraception data (Bates, et. al. 2014) and create the design matrices <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span> and dependent vector <span class="math inline">\(y\)</span>. For this model, the random effects design matrix <span class="math inline">\(Z\)</span> is specified for a random intercept model.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">Contraception</span> <span class="kw">&lt;-</span> <span class="kw pkg">mlmRev</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/mlmRev/man/Contraception.html">Contraception</a></span>

<span class="no">Contraception</span>$<span class="no">liv2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">Contraception</span>$<span class="no">livch</span> <span class="kw">==</span> <span class="st">"0"</span>, <span class="fl">0</span>, <span class="fl">1</span>)

<span class="co">##########</span>
<span class="co"># block diagonal</span>
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">Contraception</span>)), <span class="no">Contraception</span>$<span class="no">district</span>)
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">Zi.lst</span>, <span class="no">as.matrix</span>)
<span class="no">Z</span> <span class="kw">&lt;-</span> <span class="kw pkg">Matrix</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/bdiag.html">bdiag</a></span>(<span class="no">Zi.lst</span>)
<span class="no">Z</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Z</span>)

<span class="no">urban</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">Contraception</span>$<span class="no">urban</span> <span class="kw">==</span> <span class="st">"Y"</span>, <span class="fl">1</span>, <span class="fl">0</span>)

<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fl">1</span>, <span class="no">Contraception</span>$<span class="no">age</span>, <span class="no">Contraception</span>$<span class="no">age</span>^<span class="fl">2</span>, <span class="no">urban</span>, <span class="no">Contraception</span>$<span class="no">liv2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"int"</span>, <span class="st">"age"</span>, <span class="st">"age_sq"</span>, <span class="st">"urban"</span>, <span class="st">"liv2"</span>)
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">Contraception</span>$<span class="no">use</span> <span class="kw">==</span> <span class="st">"Y"</span>, <span class="fl">1</span>, <span class="fl">0</span>)</pre></body></html></div>
<div id="qr-decomposition-of-design-matrix" class="section level2">
<h2 class="hasAnchor">
<a href="#qr-decomposition-of-design-matrix" class="anchor"></a>QR decomposition of design matrix</h2>
<p>To facilitate a more efficient fitting of the model, we apply QR decomposition to the fixed effects design matrix <span class="math inline">\(X\)</span>.</p>
<p>Let <span class="math inline">\(\theta = R^*\beta\)</span> (below). The HMC estimates <span class="math inline">\(\theta\)</span>, from which we can use the deterministic formula to determine <span class="math inline">\(\beta\)</span></p>
<p><span class="math display">\[
\begin{aligned}
X &amp;= Q^* R^* \\
Q^* &amp;= Q \cdot \sqrt{n-1} \\
R^* &amp;= \frac{1}{\sqrt{n-1}}R \\
X\beta &amp;= Q^* R^* \beta \\
\beta &amp;= R^{*^{-1}}\theta
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">xqr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qr.html">qr</a></span>(<span class="no">X</span>)
<span class="no">Q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qraux.html">qr.Q</a></span>(<span class="no">xqr</span>)
<span class="no">R</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qraux.html">qr.R</a></span>(<span class="no">xqr</span>)

<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X</span>)
<span class="no">X2</span> <span class="kw">&lt;-</span> <span class="no">Q</span> * <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">n</span>-<span class="fl">1</span>)
<span class="no">Rstar</span> <span class="kw">&lt;-</span> <span class="no">R</span> / <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">n</span>-<span class="fl">1</span>)
<span class="no">Rstar_inv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span>(<span class="no">Rstar</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X2</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"int"</span>, <span class="st">"age"</span>, <span class="st">"age_sq"</span>, <span class="st">"urban"</span>, <span class="st">"liv2"</span>)

<span class="co"># new intercept from QR decomposition</span>
<span class="no">diagval</span> <span class="kw">&lt;-</span> <span class="no">X2</span>[<span class="fl">1</span>,<span class="fl">1</span>]


<span class="co">##########</span>
<span class="co"># block diagonal</span>
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">diagval</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">Contraception</span>)), <span class="no">Contraception</span>$<span class="no">district</span>)
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">Zi.lst</span>, <span class="no">as.matrix</span>)
<span class="no">Z2</span> <span class="kw">&lt;-</span> <span class="kw pkg">Matrix</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/bdiag.html">bdiag</a></span>(<span class="no">Zi.lst</span>)
<span class="no">Z2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Z2</span>)</pre></body></html></div>
</div>
<div id="likelihood-derivation" class="section level2">
<h2 class="hasAnchor">
<a href="#likelihood-derivation" class="anchor"></a>Likelihood Derivation</h2>
<p>First, we derive the likelihood for our logistic mixed effects regression model.</p>
<p><span class="math display">\[
\begin{aligned}
p(y | X, Z, \beta, u) &amp;= \prod_{i=1}^n\prod_{j=1}^m \left(\frac{1}{1 + e^{-X_{i}\beta - Z_{ij}u_i}}\right)^{y_{ij}} \left(\frac{e^{-X_i\beta - Z_{ij}u_i}}{1 + e^{-X_{i}\beta - Z_{ij}u_i}}\right)^{1-y_{ij}} \\
\log p(y|X,Z,\beta,u) &amp;= \sum_{i=1}^n\sum_{j=1}^m -y_{ij}\log (1 + e^{-X_i\beta - Z_{ij}u_i}) + (1 - y_{ij})\log e^{-X_i\beta - Z_{ij}u_i} \\
&amp;- (1-y_{ij})\log(1 + e^{-X_i\beta - Z_{ij}u_i}) \\
&amp;= \sum_{i=1}^n \sum_{j=1}^m -y_{ij}\log (1 + e^{-X_i\beta - Z_{ij}u_i}) - (1-y_{ij})(X_{ij}\beta + Z_{ij}u_i) \\
&amp;- (1-y_{ij})\log(1 + e^{-X_i\beta - Z_{ij}u_i}) \\
&amp;= \sum_{i=1}^n\sum_{j=1}^m -y_{ij}\log(1 + e^{-X_i\beta-Z_{ij}u_i}) - (X_{ij}\beta + Z_{ij}u_i - \log(1+e^{-X_i\beta-Z_{ij}u_i})) \\
&amp;+ y_{ij}(X_{ij}\beta + Z_{ij}u_i + \log(1 + e^{-X_i\beta - Z_{ij}u_i})) \\
&amp;=\sum_{i=1}^n \sum_{j=1}^m -(1 - y_{ij})(X_{i}\beta + Z_{ij}u_i) - \log(1 + e^{-X_{i}\beta - Z_{ij}u_i}) \\
&amp;= -(1 - y)^T(X\beta + Zu) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}u_i)})
\end{aligned}
\]</span></p>
</div>
</div>
<div id="priors" class="section level1">
<h1 class="hasAnchor">
<a href="#priors" class="anchor"></a>Priors</h1>
<p>Priors are needed for our parameters <span class="math inline">\(\beta\)</span> and <span class="math inline">\(G\)</span> to formulate the posterior.</p>
<p>We set a multivariate Normal prior for <span class="math inline">\(\beta\)</span></p>
<p><span class="math display">\[
\begin{aligned}
\beta &amp;\sim N(0, \Sigma_\beta) \\
&amp;\sim N(0, \sigma_\beta^2I)
\end{aligned}
\]</span></p>
<p>with pdf</p>
<p><span class="math display">\[
\begin{aligned}
p(\beta) &amp;= \frac{1}{\sqrt{\lvert 2\pi \Sigma_\beta \rvert }}e^{-\frac{1}{2}\beta^T \Sigma_\beta^{-1}\beta} \\
\log p(\beta) &amp;= -\frac{1}{2}\log(2\pi \lvert \Sigma_\beta \rvert) - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;\propto -\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta.
\end{aligned}
\]</span></p>
</div>
<div id="parameterization-for-g" class="section level1">
<h1 class="hasAnchor">
<a href="#parameterization-for-g" class="anchor"></a>Parameterization for <span class="math inline">\(G\)</span>
</h1>
<p>The parameterization approach for this model uses a strategy recommended by Betancourt, Girolami (2013) to facilitate more efficient sampling in HMC.</p>
<p>Further, the uniform parameterization of the variance parameters is replaced by a half-t family of distributions per Gelman (2006), Prior distributions for Variance parameters in hierarchical models. This parameterization is well-behaved around 0, in contrast to inverse gamma, and provides flexibility for more informed priors than a uniform distribution.</p>
<p>We select a parameterization of <span class="math inline">\(G\)</span> such that the likelihood and its gradient can be derived for HMC. To this end, we uses LDL decomposition of <span class="math inline">\(G\)</span> to form a flexibile parameterization that can easily handle restrictions (Chan, Jelizkov 2009).</p>
<p><span class="math display">\[
\begin{aligned}
u &amp;\sim N(0, G)  \\
G &amp;= L D L^T \\
&amp;= L D^{1/2} D^{1/2} L^T \\
\end{aligned}
\]</span></p>
<p>Let <span class="math inline">\(\lambda_k\)</span> where <span class="math inline">\(k = 1, ... p\)</span> denote the diagonal entries of <span class="math inline">\(D^{1/2}\)</span> and let <span class="math inline">\(a_{kj}\)</span> where <span class="math inline">\(1 \leq j &lt; k \leq p\)</span> denote free elements of lower unitrangular matrix <span class="math inline">\(L\)</span></p>
<p><span class="math display">\[
D^{1/2} := 
\begin{pmatrix}
\lambda_1 &amp; 0 &amp; ... &amp; 0 \\
0 &amp; \lambda_2 &amp; 0 ... &amp; 0 \\
... &amp; ... &amp; ... &amp; ... \\
0 &amp; 0 &amp; ... &amp; \lambda_p
\end{pmatrix}, 
L :=
\begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; ... &amp; 0 \\
a_{21} &amp; 1 &amp; 0 &amp; ... &amp; 0 \\
a_{31} &amp; a_{32} &amp; 1 &amp; ... &amp; ... \\
... &amp; ... &amp; ... &amp; ... &amp; ... \\
a_{p1} &amp; a_{p2} &amp; ... &amp; ... &amp; 1 \\
\end{pmatrix}
\]</span></p>
<p>Also define <span class="math inline">\(\lambda := (\lambda_1, ..., \lambda_p)^T\)</span> and <span class="math inline">\(a_k := (a_{k1}, ..., a_{k, k-1})^T\)</span> and <span class="math inline">\(a := (a_2^T, ..., a_p^T)^T\)</span></p>
<p>Consider priors where <span class="math inline">\(k = 1...p\)</span>. The prior for <span class="math inline">\(\lambda_k\)</span> is half-t per Gelman (2006).</p>
<p><span class="math display">\[
\begin{aligned}
p(\lambda_k) &amp;\sim \left(1 + \frac{1}{\nu}\left(\frac{\lambda_k}{A} \right)^2 \right)^{-(\nu+1)/2} \\
a|\lambda &amp;\sim N(a_0, A_0)
\end{aligned}
\]</span></p>
<p>The hyperparameter <span class="math inline">\(a_0\)</span> does not need to be zero, and <span class="math inline">\(A_0\)</span> can be correlated and may depend on <span class="math inline">\(\lambda\)</span>. In this model, we define <span class="math inline">\(a\)</span> independent of <span class="math inline">\(\lambda\)</span>.</p>
<p>Per Betancourt, Girolami (2013), we re-parameterize <span class="math inline">\(u\)</span> using a standard normal parameterization we define as <span class="math inline">\(\tau = (\tau_1, ..., \tau_q)\)</span>. Here, <span class="math inline">\(u\)</span> is a deterministic function of <span class="math inline">\(G\)</span> and <span class="math inline">\(\tau\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
\tau &amp;\sim N(0, I_q) \\
u &amp;:= L D^{1/2} \tau \\
&amp;\sim N(0, LD^{1/2} I (L D^{1/2})^T) \\
&amp;\sim N(0, L D^{1/2} D^{1/2} L^T) \\
&amp;\sim N(0, G)
\end{aligned}
\]</span></p>
<p>The distribution of <span class="math inline">\(u\)</span> therefore does not change with this parameterization. The intent of our re-parameterization is to allow <span class="math inline">\(G\)</span> and <span class="math inline">\(\tau\)</span> to be largely independent in the MCMC sampling.</p>
<div id="log-posterior-derivation" class="section level2">
<h2 class="hasAnchor">
<a href="#log-posterior-derivation" class="anchor"></a>Log posterior derivation</h2>
<p>Now that we have the log likelihood and priors specified, we can derive the log posterior.</p>
<p><span class="math display">\[
\begin{aligned}
p(\beta, u, G | y, X, Z) &amp;\propto p(y | \beta, u, G)  p(\beta, u, G) \\
&amp;\propto p(y|\beta, u, G) p(\beta) p(u|G) p(G) \\
\log p(\beta, u, G | y, X, Z) &amp;\propto \log p(y|\beta, u, G) + \log p(\beta) + \log p(u|G) + \log p(G)
\end{aligned}
\]</span></p>
<p>The log posterior is the sum of the log likelihood and the log of the prior for <span class="math inline">\(\beta\)</span>.</p>
<p>We have hyperpriors <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(a\)</span> for <span class="math inline">\(G\)</span>. Also, we use a half-t prior for variance parameters per Gelman (2006).</p>
<p><span class="math display">\[
\begin{aligned}
p(\lambda_k) &amp;\sim \left(1 + \frac{1}{\nu}\left(\frac{\lambda_k}{A} \right)^2 \right)^{-(\nu+1)/2} \\
p_{\xi_k}(\xi_k) &amp;= p_{\lambda_k}(g^{-1}(\xi_k)) \left\lvert \frac{d\lambda_k}{d\xi_k}  \right\rvert \\
&amp;= p_{\lambda_k} (e^{\xi_k})\lvert e^{\xi_k}\rvert \\
&amp;\propto  \left(1 + \frac{1}{\nu}\left(\frac{e^{\xi_k}}{A} \right)^2 \right)^{-(\nu+1)/2} e^{\xi_k}\\
&amp;\propto \left(1 + \frac{1}{\nu}\left(\frac{e^{2\xi_k}}{A^2} \right) \right)^{-(\nu+1)/2} e^{\xi_k}\\
\log p(\xi_k) &amp;\propto -\frac{\nu+1}{2}\log\left(1 + \frac{1}{\nu}\left(\frac{e^{2\xi_k}}{A^2} \right) \right) + \xi_k \\
\frac{\partial}{\partial\xi_k}\log p(\xi_k) &amp;\propto -\frac{\nu+1}{2}\frac{1}{1 + \frac{1}{\nu}\left( \frac{e^{2\xi_k}}{A^2} \right)}\frac{2e^{2\xi_k}}{\nu A^2} + 1 \\
&amp;\propto -(\nu+1)\frac{1}{1 + \nu A^2 e^{-2\xi_k}} + 1
\end{aligned}
\]</span></p>
<p>We assign a relatively uniformative prior for <span class="math inline">\(a\)</span></p>
<p><span class="math display">\[
\begin{aligned}
a_k &amp;\sim N(0, A) \\
p(a_k) &amp;\propto \lvert A  \rvert^{-1/2} e^{-\frac{1}{2} a_k^T A^{-1} a_k} \\
\log p(a_k) &amp;\propto -\frac{1}{2}a_k^T A^{-1} a_k
\end{aligned}
\]</span></p>
<p>The gradient with respect to <span class="math inline">\(a\)</span>:</p>
<p>Note that the following are equivalent</p>
<p><span class="math display">\[
\begin{aligned}
L D^{1/2}\tau = D^{1/2} \tau + \widetilde{T} a
\end{aligned}
\]</span></p>
<p>Therefore, the portion of the log likelihood dependent on <span class="math inline">\(a\)</span> becomes</p>
<p><span class="math display">\[
\begin{aligned}
l(a, ..) &amp;\propto -(1 - y)^T(X\beta + ZLD^{1/2}\tau) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}LD^{1/2}\tau_j)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
&amp;\propto -(1 - y)^T Z\widetilde{T} - \left(\frac{e^{-(X\beta + ZLD^{1/2}\tau)}}{1 + e^{-(X\beta + ZLD^{1/2}\tau)}}\right)^T  Z\widetilde{T} - A^{-1}a
\end{aligned}
\]</span></p>
<p>Finally, we write the full log posterior</p>
<p>Note: we use <span class="math inline">\(A_\xi\)</span> and <span class="math inline">\(A_a\)</span> to distinguish between hyperpriors for <span class="math inline">\(\xi\)</span> and for <span class="math inline">\(a\)</span></p>
<p><span class="math display">\[
\begin{aligned}
\log p(\beta, u, G | y, X, Z) &amp;\propto \log p(y|\beta, u, G) + \log p(\beta) + \log p(u|G) + \log p(G) \\
\log p(\beta, \gamma, \tau, \xi_1...\xi_q,a | y, X, Z) &amp;\propto \log p(y | \beta, \tau, \gamma, \xi, a) + \log p(\beta) + \log p(\gamma)+ \log p(\tau) + \log p(\xi) + \log p(a) \\
&amp;\propto  -(1 - y)^T(X\beta + Zu) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}u_i)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
&amp;\propto  -(1 - y)^T(X\beta + ZLD^{1/2}\tau) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}LD^{1/2}\tau_j)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
\end{aligned}
\]</span></p>
<p>The gradient of the log posterior must be derived for the leapfrog function</p>
<p><span class="math display">\[
\begin{aligned}
\log p(\beta, \gamma, \tau, \xi_1...\xi_q,a | y, X, Z) &amp;\propto  -(1 - y)^T(X\beta + ZLD^{1/2}\tau) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}LD^{1/2}\tau_j)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
\frac{\partial l}{\partial\beta} &amp;\propto -(1-y)^T X + \left(\frac{e^{-(X\beta + Zu)}}{1 + e^{-(X\beta + Zu)}}\right)^T X - \Sigma_\beta^{-1}\beta\\
\frac{\partial l}{\partial \tau} &amp;\propto -(1-y)^T ZLD^{1/2} + \left(\frac{e^{-(X\beta + Zu)}}{1 + e^{-(X\beta + Zu)}}\right)^T ZLD^{1/2} - \tau\\
\frac{\partial l}{\partial \xi_k} &amp;= -(1-y)^T ZLJ^{kk}\tau + \left(\frac{e^{-(X\beta + Zu)}}{1 + e^{-(X\beta + Zu)}}\right)^T ZLJ^{kk}\tau- (\nu_{\lambda_k}+1)\frac{1}{1 + \nu_{\lambda_k}A_{\lambda_k}^2 e^{-2\xi_k}}+1 \\
\frac{\partial l}{\partial a} &amp;= -(1 - y)^T Z\widetilde{T} - \left(\frac{e^{-(X\beta + ZLD^{1/2}\tau)}}{1 + e^{-(X\beta + ZLD^{1/2}\tau)}}\right)^T  Z\widetilde{T} - A^{-1}a
\end{aligned}
\]</span></p>
<p>Run HMC for logistic regression model using QR decomposed design matrices</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">N</span> <span class="kw">&lt;-</span> <span class="fl">2e3</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">412</span>)
<span class="no">initvals</span><span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fl">5</span>), <span class="co"># fixed effects</span>
                <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">60</span>, <span class="kw">mean</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">sd</span><span class="kw">=</span><span class="fl">0.1</span>), <span class="co"># random intercepts</span>
                <span class="fl">0</span>) <span class="co"># variance of random intercepts</span>


<span class="no">vnames</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>),
            <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"tau_int"</span>, <span class="fl">1</span>:<span class="fl">60</span>),
            <span class="st">"xi1"</span>)

<span class="no">epsvals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5e-2</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1e-2</span>, <span class="fl">4</span>), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">5e-2</span>, <span class="fl">61</span>))

<span class="no">t1.hmc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
<span class="no">f_hmc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/hmc.html">hmc</a></span>(<span class="kw">N</span> <span class="kw">=</span> <span class="no">N</span>, <span class="kw">theta.init</span> <span class="kw">=</span> <span class="no">initvals</span>,
             <span class="kw">epsilon</span> <span class="kw">=</span> <span class="no">epsvals</span>, <span class="kw">L</span> <span class="kw">=</span> <span class="fl">10</span>,
             <span class="kw">logPOSTERIOR</span> <span class="kw">=</span> <span class="no">glmm_bin_posterior</span>,
             <span class="kw">glogPOSTERIOR</span> <span class="kw">=</span> <span class="no">g_glmm_bin_posterior</span>,
             <span class="kw">varnames</span> <span class="kw">=</span> <span class="no">vnames</span>,
             <span class="kw">parallel</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">chains</span><span class="kw">=</span><span class="fl">2</span>,
             <span class="kw">param</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">X</span><span class="kw">=</span><span class="no">X2</span>, <span class="kw">Z</span><span class="kw">=</span><span class="no">Z2</span>, <span class="kw">n</span><span class="kw">=</span><span class="fl">60</span>, <span class="kw">nrandom</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">sig2beta</span><span class="kw">=</span><span class="fl">5</span>,
                        <span class="kw">nuxi</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">Axi</span><span class="kw">=</span><span class="fl">25</span>)  )


<span class="no">t2.hmc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
<span class="no">t2.hmc</span> - <span class="no">t1.hmc</span>
<span class="co">#&gt; Time difference of 1.015671 mins</span></pre></body></html></div>
<p>The acceptance ratio for each of the HMC chains is sufficiently high for an efficient simulation.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">f_hmc</span>$<span class="no">accept</span>/<span class="no">N</span>
<span class="co">#&gt; [1] 0.642 0.668</span></pre></body></html></div>
<p>Trace plots provide a visual indication of stationarity. These plots indicate that the MCMC chains are reasonably stationary.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/hmclearn-plots.html">mcmc_trace</a></span>(<span class="no">f_hmc</span>, <span class="kw">burnin</span><span class="kw">=</span><span class="fl">1000</span>, <span class="kw">pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>))</pre></body></html></div>
<p><img src="logistic_mixed_effects_hmclearn_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Since we used QR decomposition to transform <span class="math inline">\(\beta\)</span> prior to fitting via HMC, we need to reverse the transformation to obtain the original parameter scale.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># restore beta from Rstar in QR decomposition</span>
<span class="no">calc_beta</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">theta_param</span>, <span class="no">Rstarinv</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">Rstarinv</span> <span class="kw">%*%</span> <span class="no">theta_param</span>)
}

<span class="co"># reverse qr decomposition</span>
<span class="no">f_hmc2</span> <span class="kw">&lt;-</span> <span class="no">f_hmc</span>
<span class="no">f_hmc2</span>$<span class="no">thetaCombined</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">f_hmc</span>$<span class="no">thetaCombined</span>, <span class="kw">function</span>(<span class="no">xx</span>) {
  <span class="no">xx</span>[, <span class="fl">1</span>:<span class="fl">5</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">xx</span>[, <span class="fl">1</span>:<span class="fl">5</span>], <span class="fl">1</span>, <span class="no">calc_beta</span>, <span class="kw">Rstarinv</span><span class="kw">=</span><span class="no">Rstar_inv</span>))
  <span class="no">xx</span>
})</pre></body></html></div>
<p>The revised summary shows the posterior distribution after transformation back to the original scale.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">f_hmc2</span>)
<span class="co">#&gt; Summary of MCMC simulation</span>
<span class="co">#&gt;                     5%          25%          50%          75%          95%</span>
<span class="co">#&gt; int       -1.283256793 -1.124568592 -1.002734173 -0.892196094 -0.743844106</span>
<span class="co">#&gt; age       -0.006706952  0.001225579  0.006321360  0.011717037  0.019480038</span>
<span class="co">#&gt; age_sq    -0.005871485 -0.005200860 -0.004701708 -0.004226164 -0.003511268</span>
<span class="co">#&gt; urban      0.489288271  0.605910970  0.692737299  0.776793966  0.903821385</span>
<span class="co">#&gt; liv2       0.612500681  0.763861598  0.859371820  0.964182847  1.110210411</span>
<span class="co">#&gt; tau_int1   0.780479189  1.193227167  1.501774534  1.823264118  2.346645957</span>
<span class="co">#&gt; tau_int2  -1.100856274 -0.423314773  0.020656968  0.440318479  1.091661181</span>
<span class="co">#&gt; tau_int3  -2.093808543 -1.241365912 -0.601208224  0.052075419  0.972944209</span>
<span class="co">#&gt; tau_int4  -1.298681232 -0.737654959 -0.340983839  0.050122491  0.641056733</span>
<span class="co">#&gt; tau_int5  -1.148988944 -0.627548461 -0.259812462  0.136005451  0.637070204</span>
<span class="co">#&gt; tau_int6  -0.318446007  0.174528025  0.476302219  0.828478036  1.354050080</span>
<span class="co">#&gt; tau_int7  -0.763896811 -0.107528772  0.350683577  0.866351436  1.591453176</span>
<span class="co">#&gt; tau_int8  -1.259755545 -0.681446698 -0.301055235  0.076302886  0.623940400</span>
<span class="co">#&gt; tau_int9  -0.735237492 -0.082732146  0.322740125  0.746913753  1.414838418</span>
<span class="co">#&gt; tau_int10 -0.477038239  0.282929974  0.842059238  1.390378984  2.152831213</span>
<span class="co">#&gt; tau_int11  0.296141933  1.017000105  1.488229932  2.014273250  2.767759420</span>
<span class="co">#&gt; tau_int12 -0.774403272 -0.172193861  0.233153848  0.695922343  1.278123692</span>
<span class="co">#&gt; tau_int13 -1.214653717 -0.585148784 -0.148455573  0.294498572  0.932161752</span>
<span class="co">#&gt; tau_int14 -2.050180908 -1.598813406 -1.295859347 -1.003750478 -0.589242935</span>
<span class="co">#&gt; tau_int15 -0.917601864 -0.330883585  0.105751407  0.547811385  1.137019663</span>
<span class="co">#&gt; tau_int16 -2.385898314 -1.752488510 -1.357380695 -0.935671365 -0.290021653</span>
<span class="co">#&gt; tau_int17 -0.706017145 -0.107763612  0.331519982  0.736520581  1.330836518</span>
<span class="co">#&gt; tau_int18 -0.731887662 -0.237353813  0.116278880  0.460482565  1.015330329</span>
<span class="co">#&gt; tau_int19 -1.082225677 -0.506424295 -0.123354809  0.328776356  0.968378728</span>
<span class="co">#&gt; tau_int20 -1.750347086 -1.067495975 -0.609631107 -0.140318159  0.626880566</span>
<span class="co">#&gt; tau_int21 -1.232223807 -0.598587557 -0.116523316  0.353333248  1.065071669</span>
<span class="co">#&gt; tau_int22 -0.240675626  0.367738026  0.798390385  1.305915919  1.981141562</span>
<span class="co">#&gt; tau_int23 -0.832037125 -0.151690911  0.301857741  0.773441498  1.488058066</span>
<span class="co">#&gt; tau_int24 -0.301709912  0.462757359  0.998525080  1.507137852  2.186063757</span>
<span class="co">#&gt; tau_int25 -1.065456738 -0.619909615 -0.310266407 -0.022485206  0.417455295</span>
<span class="co">#&gt; tau_int26 -1.208098362 -0.478794326  0.048964316  0.589401318  1.399757123</span>
<span class="co">#&gt; tau_int27  0.063419409  0.577336559  0.971102245  1.344958099  1.920420894</span>
<span class="co">#&gt; tau_int28 -0.242415163  0.273105257  0.621363548  0.978868514  1.538225059</span>
<span class="co">#&gt; tau_int29 -0.700521110 -0.130015745  0.271537073  0.686259447  1.300411225</span>
<span class="co">#&gt; tau_int30 -1.594608527 -1.148914568 -0.831313970 -0.515990846 -0.022078167</span>
<span class="co">#&gt; tau_int31 -1.697059216 -1.159871779 -0.779580437 -0.386372470  0.194845505</span>
<span class="co">#&gt; tau_int32 -0.138891705  0.441986914  0.858261122  1.322031480  1.940902014</span>
<span class="co">#&gt; tau_int33 -1.014701459 -0.321840755  0.168588368  0.652343142  1.338058450</span>
<span class="co">#&gt; tau_int34 -2.334770278 -1.745773867 -1.364543946 -0.992625073 -0.449807932</span>
<span class="co">#&gt; tau_int35 -1.350557717 -0.864745868 -0.501234796 -0.159809216  0.366155663</span>
<span class="co">#&gt; tau_int36 -0.919407559 -0.280700590  0.157043940  0.610437051  1.253367340</span>
<span class="co">#&gt; tau_int37 -2.035919669 -1.250233587 -0.700654614 -0.208154095  0.610259949</span>
<span class="co">#&gt; tau_int38 -1.017330447 -0.316289914  0.186466931  0.673171961  1.448798745</span>
<span class="co">#&gt; tau_int39 -1.963878335 -1.350763270 -0.948787342 -0.515640590  0.119190936</span>
<span class="co">#&gt; tau_int40 -1.047701734 -0.552361854 -0.187803574  0.189161098  0.715411454</span>
<span class="co">#&gt; tau_int41 -1.630333172 -0.986370075 -0.536059087 -0.129150472  0.533077040</span>
<span class="co">#&gt; tau_int42 -1.752847082 -0.947284943 -0.421178393  0.113229776  0.853649147</span>
<span class="co">#&gt; tau_int43 -1.870947952 -1.373198363 -1.027362268 -0.670951748 -0.155506946</span>
<span class="co">#&gt; tau_int44 -0.376729268  0.255561302  0.705642044  1.158862996  1.839654550</span>
<span class="co">#&gt; tau_int45 -0.705255303 -0.147584511  0.219430062  0.603785763  1.169342883</span>
<span class="co">#&gt; tau_int46 -1.845803725 -1.377348837 -1.065491830 -0.797198441 -0.417733610</span>
<span class="co">#&gt; tau_int47 -1.517225553 -0.883711910 -0.361814699  0.143292225  0.905945282</span>
<span class="co">#&gt; tau_int48 -1.870119921 -1.289173445 -0.903362084 -0.507581865  0.013829329</span>
<span class="co">#&gt; tau_int49 -1.002982762 -0.102465784  0.512844687  1.103707375  2.003292991</span>
<span class="co">#&gt; tau_int50 -1.700427116 -1.017327342 -0.591009161 -0.117073857  0.590255089</span>
<span class="co">#&gt; tau_int51 -1.142328889 -0.574674293 -0.194544334  0.204010604  0.819788125</span>
<span class="co">#&gt; tau_int52 -1.310984137 -0.822355855 -0.470649266 -0.175466197  0.322183139</span>
<span class="co">#&gt; tau_int53 -0.831511088 -0.165008867  0.255701276  0.722358236  1.425404689</span>
<span class="co">#&gt; tau_int54 -0.521350363  0.281017921  0.808256741  1.328099594  2.098707768</span>
<span class="co">#&gt; tau_int55 -2.123751339 -1.583602926 -1.200362448 -0.863050288 -0.370005999</span>
<span class="co">#&gt; tau_int56  0.010825967  0.601246453  1.053242995  1.503880127  2.226671276</span>
<span class="co">#&gt; tau_int57 -1.591438307 -0.975002375 -0.598856302 -0.198558485  0.441643546</span>
<span class="co">#&gt; tau_int58 -0.550404245  0.191511765  0.758029578  1.338242484  2.089408709</span>
<span class="co">#&gt; tau_int59  0.017846000  0.557980835  0.914549520  1.375679029  1.993516387</span>
<span class="co">#&gt; tau_int60  0.121432940  0.656173882  1.033115717  1.428643087  2.004893851</span>
<span class="co">#&gt; xi1       -0.983744899 -0.794337729 -0.671370742 -0.554247786 -0.408169286</span>
<span class="co">#&gt;                rhat</span>
<span class="co">#&gt; int       0.9998688</span>
<span class="co">#&gt; age       0.9998760</span>
<span class="co">#&gt; age_sq    1.0000776</span>
<span class="co">#&gt; urban     0.9997921</span>
<span class="co">#&gt; liv2      1.0001743</span>
<span class="co">#&gt; tau_int1  1.0023007</span>
<span class="co">#&gt; tau_int2  0.9998076</span>
<span class="co">#&gt; tau_int3  1.0076584</span>
<span class="co">#&gt; tau_int4  1.0013928</span>
<span class="co">#&gt; tau_int5  1.0020610</span>
<span class="co">#&gt; tau_int6  1.0025418</span>
<span class="co">#&gt; tau_int7  1.0028852</span>
<span class="co">#&gt; tau_int8  1.0021608</span>
<span class="co">#&gt; tau_int9  1.0038141</span>
<span class="co">#&gt; tau_int10 1.0028347</span>
<span class="co">#&gt; tau_int11 1.0005468</span>
<span class="co">#&gt; tau_int12 0.9997725</span>
<span class="co">#&gt; tau_int13 1.0001975</span>
<span class="co">#&gt; tau_int14 1.0025155</span>
<span class="co">#&gt; tau_int15 1.0016800</span>
<span class="co">#&gt; tau_int16 1.0007538</span>
<span class="co">#&gt; tau_int17 1.0007356</span>
<span class="co">#&gt; tau_int18 1.0021900</span>
<span class="co">#&gt; tau_int19 0.9998152</span>
<span class="co">#&gt; tau_int20 1.0044432</span>
<span class="co">#&gt; tau_int21 1.0082939</span>
<span class="co">#&gt; tau_int22 0.9997606</span>
<span class="co">#&gt; tau_int23 1.0008348</span>
<span class="co">#&gt; tau_int24 1.0054622</span>
<span class="co">#&gt; tau_int25 1.0024121</span>
<span class="co">#&gt; tau_int26 1.0017841</span>
<span class="co">#&gt; tau_int27 0.9999545</span>
<span class="co">#&gt; tau_int28 0.9999469</span>
<span class="co">#&gt; tau_int29 1.0040069</span>
<span class="co">#&gt; tau_int30 0.9999720</span>
<span class="co">#&gt; tau_int31 1.0340655</span>
<span class="co">#&gt; tau_int32 1.0132443</span>
<span class="co">#&gt; tau_int33 1.0013281</span>
<span class="co">#&gt; tau_int34 1.0054018</span>
<span class="co">#&gt; tau_int35 1.0009634</span>
<span class="co">#&gt; tau_int36 1.0014518</span>
<span class="co">#&gt; tau_int37 1.0178788</span>
<span class="co">#&gt; tau_int38 1.0009140</span>
<span class="co">#&gt; tau_int39 1.0028975</span>
<span class="co">#&gt; tau_int40 0.9999312</span>
<span class="co">#&gt; tau_int41 0.9998765</span>
<span class="co">#&gt; tau_int42 1.0007256</span>
<span class="co">#&gt; tau_int43 0.9998216</span>
<span class="co">#&gt; tau_int44 1.0006158</span>
<span class="co">#&gt; tau_int45 1.0056953</span>
<span class="co">#&gt; tau_int46 1.0018409</span>
<span class="co">#&gt; tau_int47 1.0017286</span>
<span class="co">#&gt; tau_int48 1.0000907</span>
<span class="co">#&gt; tau_int49 1.0087931</span>
<span class="co">#&gt; tau_int50 1.0010188</span>
<span class="co">#&gt; tau_int51 1.0008374</span>
<span class="co">#&gt; tau_int52 1.0078820</span>
<span class="co">#&gt; tau_int53 1.0015843</span>
<span class="co">#&gt; tau_int54 0.9998281</span>
<span class="co">#&gt; tau_int55 0.9998167</span>
<span class="co">#&gt; tau_int56 0.9998265</span>
<span class="co">#&gt; tau_int57 0.9997519</span>
<span class="co">#&gt; tau_int58 0.9997789</span>
<span class="co">#&gt; tau_int59 1.0049978</span>
<span class="co">#&gt; tau_int60 1.0082010</span>
<span class="co">#&gt; xi1       1.0000124</span></pre></body></html></div>
<p>We create trace plots on the transformed simulation data.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/hmclearn-plots.html">mcmc_trace</a></span>(<span class="no">f_hmc2</span>, <span class="kw">burnin</span><span class="kw">=</span><span class="fl">1000</span>, <span class="kw">pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>))</pre></body></html></div>
<p><img src="logistic_mixed_effects_hmclearn_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
</div>
</div>
<div id="frequentist-model" class="section level1">
<h1 class="hasAnchor">
<a href="#frequentist-model" class="anchor"></a>Frequentist model</h1>
<p>To compare results, we first fit a logistic mixed effects model using the frequentist package <strong>lme4</strong> (Bates et. al. 2015).</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lme4</span>)
<span class="co">#&gt; Loading required package: Matrix</span>

<span class="no">f</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(<span class="no">use</span> ~ <span class="no">age</span> + <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span>(<span class="no">age</span>^<span class="fl">2</span>) + <span class="no">urban</span> + <span class="no">liv2</span> + (<span class="fl">1</span> <span class="kw">|</span> <span class="no">district</span>),
           <span class="kw">data</span><span class="kw">=</span><span class="no">Contraception</span>, <span class="kw">family</span><span class="kw">=</span><span class="no">binomial</span>,
           <span class="kw">control</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">glmerControl</a></span>(<span class="kw">optCtrl</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">maxfun</span><span class="kw">=</span><span class="fl">20000</span>)))
<span class="co">#&gt; Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, : Model is nearly unidentifiable: very large eigenvalue</span>
<span class="co">#&gt;  - Rescale variables?</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">f</span>)
<span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span>
<span class="co">#&gt;   Approximation) [glmerMod]</span>
<span class="co">#&gt;  Family: binomial  ( logit )</span>
<span class="co">#&gt; Formula: use ~ age + I(age^2) + urban + liv2 + (1 | district)</span>
<span class="co">#&gt;    Data: Contraception</span>
<span class="co">#&gt; Control: glmerControl(optCtrl = list(maxfun = 20000))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span>
<span class="co">#&gt;   2385.2   2418.6  -1186.6   2373.2     1928 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Scaled residuals: </span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -1.8151 -0.7620 -0.4619  0.9518  3.1033 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span>
<span class="co">#&gt;  district (Intercept) 0.2247   0.474   </span>
<span class="co">#&gt; Number of obs: 1934, groups:  district, 60</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="co">#&gt; (Intercept) -1.0063737  0.1691107  -5.951 2.67e-09 ***</span>
<span class="co">#&gt; age          0.0062561  0.0078848   0.793    0.428    </span>
<span class="co">#&gt; I(age^2)    -0.0046353  0.0007207  -6.432 1.26e-10 ***</span>
<span class="co">#&gt; urbanY       0.6929220  0.1206566   5.743 9.31e-09 ***</span>
<span class="co">#&gt; liv2         0.8603821  0.1483014   5.802 6.57e-09 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Correlation of Fixed Effects:</span>
<span class="co">#&gt;          (Intr) age    I(g^2) urbanY</span>
<span class="co">#&gt; age       0.529                     </span>
<span class="co">#&gt; I(age^2) -0.533 -0.506              </span>
<span class="co">#&gt; urbanY   -0.259 -0.032  0.020       </span>
<span class="co">#&gt; liv2     -0.801 -0.565  0.345  0.094</span>
<span class="co">#&gt; convergence code: 0</span>
<span class="co">#&gt; Model is nearly unidentifiable: very large eigenvalue</span>
<span class="co">#&gt;  - Rescale variables?</span></pre></body></html></div>
<div class="sourceCode" id="cb11"><html><body><pre class="r">
<span class="no">freqvals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/lme4/man/fixef.html">fixef</a></span>(<span class="no">f</span>)),
              <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/lme4/man/ranef.html">ranef</a></span>(<span class="no">f</span>)$<span class="no">district</span>[, <span class="fl">1</span>]),
              <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/lme4/man/VarCorr.html">VarCorr</a></span>(<span class="no">f</span>)[<span class="fl">1</span>]))))</pre></body></html></div>
<p>Histograms of the posterior distribution show that Bayesian parameter estimates align with frequentist estimates. The <em>cols</em> parameter specifies the parameters to be displayed in <em>diagplots</em>, based on the order provided to the <em>hmc</em> function.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="../reference/diagplots.html">diagplots</a></span>(<span class="no">f_hmc2</span>, <span class="kw">burnin</span><span class="kw">=</span><span class="fl">1000</span>,
          <span class="kw">actual.mu</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">freqvals</span>[<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>)], <span class="no">freqvals</span>[<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">freqvals</span>)]),
          <span class="kw">cols</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">initvals</span>)))
<span class="co">#&gt; $histogram</span></pre></body></html></div>
<p><img src="logistic_mixed_effects_hmclearn_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
</div>
<div id="source" class="section level1">
<h1 class="hasAnchor">
<a href="#source" class="anchor"></a>Source</h1>
<p>Steele, F., Diamond, I. And Amin, S. (1996). Immunization uptake in rural Bangladesh: a multilevel analysis. <em>Journal of the Royal Statistical Society</em>, Series A (159): 289-299.</p>
<p></p>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<p>Bates, D., M"{a}chler, M., Bolker, B., &amp; Walker, S. (2015). Fitting linear mixed-effects models using lme4. <em>Journal of Statistical Software</em> 67(1)</p>
<p>Bates, D., M"{a}chler, M., &amp; Bolker, B. (2014). mlmRev: Examples from multilevel modelling software review. <em>R package version, 1</em>.</p>
<p>Agresti, A. (2015). <em>Foundations of linear and generalized linear models</em>. John Wiley &amp; Sons. ISBN: 978-1-118-73003-4</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Samuel Thomas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
