<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>hmclearn package:  Logistic Mixed Effects Regression Example • hmclearn</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="hmclearn package:  Logistic Mixed Effects Regression Example">
<meta property="og:description" content="hmclearn">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hmclearn</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/linear_mixed_effects_hmclearn.html">hmclearn package:  Linear Mixed Effects Regression Example</a>
    </li>
    <li>
      <a href="../articles/linear_regression_hmclearn.html">hmclearn package:  Linear Regression Example</a>
    </li>
    <li>
      <a href="../articles/logistic_mixed_effects_hmclearn.html">hmclearn package:  Logistic Mixed Effects Regression Example</a>
    </li>
    <li>
      <a href="../articles/logistic_regression_hmclearn.html">hmclearn:  Logistic Regression Example</a>
    </li>
    <li>
      <a href="../articles/poisson_regression_hmclearn.html">hmclearn:  Poisson Regression Example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>hmclearn package: Logistic Mixed Effects Regression Example</h1>
                        <h4 class="author">Samuel Thomas</h4>
            
            <h4 class="date">2020-05-01</h4>
      
      
      <div class="hidden name"><code>logistic_mixed_effects_hmclearn.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette demonstrates fitting a Logistic mixed effects regression model via Hamiltonian Monte Carlo (HMC) using the <strong>hmclearn</strong> package.</p>
<p>For a mixed effects model with binary response, we let</p>
<p><span class="math display">\[
p = Pr(Y = 1 | X, Z) = [1 + e^{-X\beta-Zu}]^{-1}
\]</span> or</p>
<p><span class="math display">\[
\begin{aligned}
\text{logit}[P(y = 1 | u)] &amp;= X\beta + Zu \\
u &amp;\sim N(0, G)
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">hmclearn</span>)</pre></body></html></div>
</div>
<div id="logistic-mixed-effects-model-example-data" class="section level1">
<h1 class="hasAnchor">
<a href="#logistic-mixed-effects-model-example-data" class="anchor"></a>Logistic Mixed Effects Model Example Data</h1>
<p>The user must define provide the design matrix directly for use in <strong>hmclearn</strong>. Our first step is to load the data and store the fixed effect design matrix <span class="math inline">\(X\)</span>, random effects design matrix <span class="math inline">\(Z\)</span>, and dependent variable vector <span class="math inline">\(y\)</span>.</p>
<p>We load drug Contraception data (Bates, et. al. 2014) and create the design matrices <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span> and dependent vector <span class="math inline">\(y\)</span>. For this model, the random effects design matrix <span class="math inline">\(Z\)</span> is specified for a random intercept model.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">Contraception</span> <span class="kw">&lt;-</span> <span class="kw pkg">mlmRev</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/mlmRev/man/Contraception.html">Contraception</a></span>

<span class="no">Contraception</span>$<span class="no">liv2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">Contraception</span>$<span class="no">livch</span> <span class="kw">==</span> <span class="st">"0"</span>, <span class="fl">0</span>, <span class="fl">1</span>)

<span class="co">##########</span>
<span class="co"># block diagonal</span>
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">Contraception</span>)), <span class="no">Contraception</span>$<span class="no">district</span>)
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">Zi.lst</span>, <span class="no">as.matrix</span>)
<span class="no">Z</span> <span class="kw">&lt;-</span> <span class="kw pkg">Matrix</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/bdiag.html">bdiag</a></span>(<span class="no">Zi.lst</span>)
<span class="no">Z</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Z</span>)

<span class="no">urban</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">Contraception</span>$<span class="no">urban</span> <span class="kw">==</span> <span class="st">"Y"</span>, <span class="fl">1</span>, <span class="fl">0</span>)

<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fl">1</span>, <span class="no">Contraception</span>$<span class="no">age</span>, <span class="no">Contraception</span>$<span class="no">age</span>^<span class="fl">2</span>, <span class="no">urban</span>, <span class="no">Contraception</span>$<span class="no">liv2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"int"</span>, <span class="st">"age"</span>, <span class="st">"age_sq"</span>, <span class="st">"urban"</span>, <span class="st">"liv2"</span>)
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">Contraception</span>$<span class="no">use</span> <span class="kw">==</span> <span class="st">"Y"</span>, <span class="fl">1</span>, <span class="fl">0</span>)</pre></body></html></div>
<div id="qr-decomposition-of-design-matrix" class="section level2">
<h2 class="hasAnchor">
<a href="#qr-decomposition-of-design-matrix" class="anchor"></a>QR decomposition of design matrix</h2>
<p>To facilitate a more efficient fitting of the model, we apply QR decomposition to the fixed effects design matrix <span class="math inline">\(X\)</span>.</p>
<p>Let <span class="math inline">\(\theta = R^*\beta\)</span> (below). The HMC estimates <span class="math inline">\(\theta\)</span>, from which we can use the deterministic formula to determine <span class="math inline">\(\beta\)</span></p>
<p><span class="math display">\[
\begin{aligned}
X &amp;= Q^* R^* \\
Q^* &amp;= Q \cdot \sqrt{n-1} \\
R^* &amp;= \frac{1}{\sqrt{n-1}}R \\
X\beta &amp;= Q^* R^* \beta \\
\beta &amp;= R^{*^{-1}}\theta
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">xqr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qr.html">qr</a></span>(<span class="no">X</span>)
<span class="no">Q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qraux.html">qr.Q</a></span>(<span class="no">xqr</span>)
<span class="no">R</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qraux.html">qr.R</a></span>(<span class="no">xqr</span>)

<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X</span>)
<span class="no">X2</span> <span class="kw">&lt;-</span> <span class="no">Q</span> * <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">n</span>-<span class="fl">1</span>)
<span class="no">Rstar</span> <span class="kw">&lt;-</span> <span class="no">R</span> / <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">n</span>-<span class="fl">1</span>)
<span class="no">Rstar_inv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span>(<span class="no">Rstar</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X2</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"int"</span>, <span class="st">"age"</span>, <span class="st">"age_sq"</span>, <span class="st">"urban"</span>, <span class="st">"liv2"</span>)

<span class="co"># new intercept from QR decomposition</span>
<span class="no">diagval</span> <span class="kw">&lt;-</span> <span class="no">X2</span>[<span class="fl">1</span>,<span class="fl">1</span>]


<span class="co">##########</span>
<span class="co"># block diagonal</span>
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">diagval</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">Contraception</span>)), <span class="no">Contraception</span>$<span class="no">district</span>)
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">Zi.lst</span>, <span class="no">as.matrix</span>)
<span class="no">Z2</span> <span class="kw">&lt;-</span> <span class="kw pkg">Matrix</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/bdiag.html">bdiag</a></span>(<span class="no">Zi.lst</span>)
<span class="no">Z2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Z2</span>)</pre></body></html></div>
</div>
<div id="likelihood-derivation" class="section level2">
<h2 class="hasAnchor">
<a href="#likelihood-derivation" class="anchor"></a>Likelihood Derivation</h2>
<p>First, we derive the likelihood for our logistic mixed effects regression model.</p>
<p><span class="math display">\[
\begin{aligned}
p(y | X, Z, \beta, u) &amp;= \prod_{i=1}^n\prod_{j=1}^m \left(\frac{1}{1 + e^{-X_{i}\beta - Z_{ij}u_i}}\right)^{y_{ij}} \left(\frac{e^{-X_i\beta - Z_{ij}u_i}}{1 + e^{-X_{i}\beta - Z_{ij}u_i}}\right)^{1-y_{ij}} \\
\log p(y|X,Z,\beta,u) &amp;= \sum_{i=1}^n\sum_{j=1}^m -y_{ij}\log (1 + e^{-X_i\beta - Z_{ij}u_i}) + (1 - y_{ij})\log e^{-X_i\beta - Z_{ij}u_i} \\
&amp;- (1-y_{ij})\log(1 + e^{-X_i\beta - Z_{ij}u_i}) \\
&amp;= \sum_{i=1}^n \sum_{j=1}^m -y_{ij}\log (1 + e^{-X_i\beta - Z_{ij}u_i}) - (1-y_{ij})(X_{ij}\beta + Z_{ij}u_i) \\
&amp;- (1-y_{ij})\log(1 + e^{-X_i\beta - Z_{ij}u_i}) \\
&amp;= \sum_{i=1}^n\sum_{j=1}^m -y_{ij}\log(1 + e^{-X_i\beta-Z_{ij}u_i}) - (X_{ij}\beta + Z_{ij}u_i - \log(1+e^{-X_i\beta-Z_{ij}u_i})) \\
&amp;+ y_{ij}(X_{ij}\beta + Z_{ij}u_i + \log(1 + e^{-X_i\beta - Z_{ij}u_i})) \\
&amp;=\sum_{i=1}^n \sum_{j=1}^m -(1 - y_{ij})(X_{i}\beta + Z_{ij}u_i) - \log(1 + e^{-X_{i}\beta - Z_{ij}u_i}) \\
&amp;= -(1 - y)^T(X\beta + Zu) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}u_i)})
\end{aligned}
\]</span></p>
</div>
</div>
<div id="priors" class="section level1">
<h1 class="hasAnchor">
<a href="#priors" class="anchor"></a>Priors</h1>
<p>Priors are needed for our parameters <span class="math inline">\(\beta\)</span> and <span class="math inline">\(G\)</span> to formulate the posterior.</p>
<p>We set a multivariate Normal prior for <span class="math inline">\(\beta\)</span></p>
<p><span class="math display">\[
\begin{aligned}
\beta &amp;\sim N(0, \Sigma_\beta) \\
&amp;\sim N(0, BI)
\end{aligned}
\]</span></p>
<p>with pdf</p>
<p><span class="math display">\[
\begin{aligned}
p(\beta) &amp;= \frac{1}{\sqrt{\lvert 2\pi \Sigma_\beta \rvert }}e^{-\frac{1}{2}\beta^T \Sigma_\beta^{-1}\beta} \\
\log p(\beta) &amp;= -\frac{1}{2}\log(2\pi \lvert \Sigma_\beta \rvert) - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;\propto -\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta.
\end{aligned}
\]</span></p>
</div>
<div id="parameterization-for-g" class="section level1">
<h1 class="hasAnchor">
<a href="#parameterization-for-g" class="anchor"></a>Parameterization for <span class="math inline">\(G\)</span>
</h1>
<p>The parameterization approach for this model uses a strategy recommended by Betancourt, Girolami (2013) to facilitate more efficient sampling in HMC.</p>
<p>Further, the uniform parameterization of the variance parameters is replaced by a half-t family of distributions per Gelman (2006), Prior distributions for Variance parameters in hierarchical models. This parameterization is well-behaved around 0, in contrast to inverse gamma, and provides flexibility for more informed priors than a uniform distribution.</p>
<p>We select a parameterization of <span class="math inline">\(G\)</span> such that the likelihood and its gradient can be derived for HMC. To this end, we uses LDL decomposition of <span class="math inline">\(G\)</span> to form a flexibile parameterization that can easily handle restrictions (Chan, Jelizkov 2009).</p>
<p><span class="math display">\[
\begin{aligned}
u &amp;\sim N(0, G)  \\
G &amp;= L D L^T \\
&amp;= L D^{1/2} D^{1/2} L^T \\
\end{aligned}
\]</span></p>
<p>Let <span class="math inline">\(\lambda_k\)</span> where <span class="math inline">\(k = 1, ... p\)</span> denote the diagonal entries of <span class="math inline">\(D^{1/2}\)</span> and let <span class="math inline">\(a_{kj}\)</span> where <span class="math inline">\(1 \leq j &lt; k \leq p\)</span> denote free elements of lower unitrangular matrix <span class="math inline">\(L\)</span></p>
<p><span class="math display">\[
D^{1/2} := 
\begin{pmatrix}
\lambda_1 &amp; 0 &amp; ... &amp; 0 \\
0 &amp; \lambda_2 &amp; 0 ... &amp; 0 \\
... &amp; ... &amp; ... &amp; ... \\
0 &amp; 0 &amp; ... &amp; \lambda_p
\end{pmatrix}, 
L :=
\begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; ... &amp; 0 \\
a_{21} &amp; 1 &amp; 0 &amp; ... &amp; 0 \\
a_{31} &amp; a_{32} &amp; 1 &amp; ... &amp; ... \\
... &amp; ... &amp; ... &amp; ... &amp; ... \\
a_{p1} &amp; a_{p2} &amp; ... &amp; ... &amp; 1 \\
\end{pmatrix}
\]</span></p>
<p>Also define <span class="math inline">\(\lambda := (\lambda_1, ..., \lambda_p)^T\)</span> and <span class="math inline">\(a_k := (a_{k1}, ..., a_{k, k-1})^T\)</span> and <span class="math inline">\(a := (a_2^T, ..., a_p^T)^T\)</span></p>
<p>Consider priors where <span class="math inline">\(k = 1...p\)</span>. The prior for <span class="math inline">\(\lambda_k\)</span> is half-t per Gelman (2006).</p>
<p><span class="math display">\[
\begin{aligned}
p(\lambda_k) &amp;\sim \left(1 + \frac{1}{\nu}\left(\frac{\lambda_k}{A} \right)^2 \right)^{-(\nu+1)/2} \\
a|\lambda &amp;\sim N(a_0, A_0)
\end{aligned}
\]</span></p>
<p>The hyperparameter <span class="math inline">\(a_0\)</span> does not need to be zero, and <span class="math inline">\(A_0\)</span> can be correlated and may depend on <span class="math inline">\(\lambda\)</span>. In this model, we define <span class="math inline">\(a\)</span> independent of <span class="math inline">\(\lambda\)</span>.</p>
<p>Per Betancourt, Girolami (2013), we re-parameterize <span class="math inline">\(u\)</span> using a standard normal parameterization we define as <span class="math inline">\(\tau = (\tau_1, ..., \tau_q)\)</span>. Here, <span class="math inline">\(u\)</span> is a deterministic function of <span class="math inline">\(G\)</span> and <span class="math inline">\(\tau\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
\tau &amp;\sim N(0, I_q) \\
u &amp;:= L D^{1/2} \tau \\
&amp;\sim N(0, LD^{1/2} I (L D^{1/2})^T) \\
&amp;\sim N(0, L D^{1/2} D^{1/2} L^T) \\
&amp;\sim N(0, G)
\end{aligned}
\]</span></p>
<p>The distribution of <span class="math inline">\(u\)</span> therefore does not change with this parameterization. The intent of our re-parameterization is to allow <span class="math inline">\(G\)</span> and <span class="math inline">\(\tau\)</span> to be largely independent in the MCMC sampling.</p>
<div id="log-posterior-derivation" class="section level2">
<h2 class="hasAnchor">
<a href="#log-posterior-derivation" class="anchor"></a>Log posterior derivation</h2>
<p>Now that we have the log likelihood and priors specified, we can derive the log posterior.</p>
<p><span class="math display">\[
\begin{aligned}
p(\beta, u, G | y, X, Z) &amp;\propto p(y | \beta, u, G)  p(\beta, u, G) \\
&amp;\propto p(y|\beta, u, G) p(\beta) p(u|G) p(G) \\
\log p(\beta, u, G | y, X, Z) &amp;\propto \log p(y|\beta, u, G) + \log p(\beta) + \log p(u|G) + \log p(G)
\end{aligned}
\]</span></p>
<p>The log posterior is the sum of the log likelihood and the log of the prior for <span class="math inline">\(\beta\)</span>.</p>
<p>We have hyperpriors <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(a\)</span> for <span class="math inline">\(G\)</span>. Also, we use a half-t prior for variance parameters per Gelman (2006).</p>
<p><span class="math display">\[
\begin{aligned}
p(\lambda_k) &amp;\sim \left(1 + \frac{1}{\nu}\left(\frac{\lambda_k}{A} \right)^2 \right)^{-(\nu+1)/2} \\
p_{\xi_k}(\xi_k) &amp;= p_{\lambda_k}(g^{-1}(\xi_k)) \left\lvert \frac{d\lambda_k}{d\xi_k}  \right\rvert \\
&amp;= p_{\lambda_k} (e^{\xi_k})\lvert e^{\xi_k}\rvert \\
&amp;\propto  \left(1 + \frac{1}{\nu}\left(\frac{e^{\xi_k}}{A} \right)^2 \right)^{-(\nu+1)/2} e^{\xi_k}\\
&amp;\propto \left(1 + \frac{1}{\nu}\left(\frac{e^{2\xi_k}}{A^2} \right) \right)^{-(\nu+1)/2} e^{\xi_k}\\
\log p(\xi_k) &amp;\propto -\frac{\nu+1}{2}\log\left(1 + \frac{1}{\nu}\left(\frac{e^{2\xi_k}}{A^2} \right) \right) + \xi_k \\
\frac{\partial}{\partial\xi_k}\log p(\xi_k) &amp;\propto -\frac{\nu+1}{2}\frac{1}{1 + \frac{1}{\nu}\left( \frac{e^{2\xi_k}}{A^2} \right)}\frac{2e^{2\xi_k}}{\nu A^2} + 1 \\
&amp;\propto -(\nu+1)\frac{1}{1 + \nu A^2 e^{-2\xi_k}} + 1
\end{aligned}
\]</span></p>
<p>We assign a relatively uniformative prior for <span class="math inline">\(a\)</span></p>
<p><span class="math display">\[
\begin{aligned}
a_k &amp;\sim N(0, A) \\
p(a_k) &amp;\propto \lvert A  \rvert^{-1/2} e^{-\frac{1}{2} a_k^T A^{-1} a_k} \\
\log p(a_k) &amp;\propto -\frac{1}{2}a_k^T A^{-1} a_k
\end{aligned}
\]</span></p>
<p>The gradient with respect to <span class="math inline">\(a\)</span>:</p>
<p>Note that the following are equivalent</p>
<p><span class="math display">\[
\begin{aligned}
L D^{1/2}\tau = D^{1/2} \tau + \widetilde{T} a
\end{aligned}
\]</span></p>
<p>Therefore, the portion of the log likelihood dependent on <span class="math inline">\(a\)</span> becomes</p>
<p><span class="math display">\[
\begin{aligned}
l(a, ..) &amp;\propto -(1 - y)^T(X\beta + ZLD^{1/2}\tau) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}LD^{1/2}\tau_j)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
&amp;\propto -(1 - y)^T Z\widetilde{T} - \left(\frac{e^{-(X\beta + ZLD^{1/2}\tau)}}{1 + e^{-(X\beta + ZLD^{1/2}\tau)}}\right)^T  Z\widetilde{T} - A^{-1}a
\end{aligned}
\]</span></p>
<p>Finally, we write the full log posterior</p>
<p>Note: we use <span class="math inline">\(A_\xi\)</span> and <span class="math inline">\(A_a\)</span> to distinguish between hyperpriors for <span class="math inline">\(\xi\)</span> and for <span class="math inline">\(a\)</span></p>
<p><span class="math display">\[
\begin{aligned}
\log p(\beta, u, G | y, X, Z) &amp;\propto \log p(y|\beta, u, G) + \log p(\beta) + \log p(u|G) + \log p(G) \\
\log p(\beta, \gamma, \tau, \xi_1...\xi_q,a | y, X, Z) &amp;\propto \log p(y | \beta, \tau, \gamma, \xi, a) + \log p(\beta) + \log p(\gamma)+ \log p(\tau) + \log p(\xi) + \log p(a) \\
&amp;\propto  -(1 - y)^T(X\beta + Zu) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}u_i)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
&amp;\propto  -(1 - y)^T(X\beta + ZLD^{1/2}\tau) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}LD^{1/2}\tau_j)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
\end{aligned}
\]</span></p>
<p>The gradient of the log posterior must be derived for the leapfrog function</p>
<p><span class="math display">\[
\begin{aligned}
\log p(\beta, \gamma, \tau, \xi_1...\xi_q,a | y, X, Z) &amp;\propto  -(1 - y)^T(X\beta + ZLD^{1/2}\tau) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}LD^{1/2}\tau_j)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
\frac{\partial l}{\partial\beta} &amp;\propto -(1-y)^T X + \left(\frac{e^{-(X\beta + Zu)}}{1 + e^{-(X\beta + Zu)}}\right)^T X - \Sigma_\beta^{-1}\beta\\
\frac{\partial l}{\partial \tau} &amp;\propto -(1-y)^T ZLD^{1/2} + \left(\frac{e^{-(X\beta + Zu)}}{1 + e^{-(X\beta + Zu)}}\right)^T ZLD^{1/2} - \tau\\
\frac{\partial l}{\partial \xi_k} &amp;= -(1-y)^T ZLJ^{kk}\tau + \left(\frac{e^{-(X\beta + Zu)}}{1 + e^{-(X\beta + Zu)}}\right)^T ZLJ^{kk}\tau- (\nu_{\lambda_k}+1)\frac{1}{1 + \nu_{\lambda_k}A_{\lambda_k}^2 e^{-2\xi_k}}+1 \\
\frac{\partial l}{\partial a} &amp;= -(1 - y)^T Z\widetilde{T} - \left(\frac{e^{-(X\beta + ZLD^{1/2}\tau)}}{1 + e^{-(X\beta + ZLD^{1/2}\tau)}}\right)^T  Z\widetilde{T} - A^{-1}a
\end{aligned}
\]</span></p>
<p>Run HMC for logistic regression model using QR decomposed design matrices</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">N</span> <span class="kw">&lt;-</span> <span class="fl">2e3</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">412</span>)
<span class="no">initvals</span><span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fl">5</span>), <span class="co"># fixed effects</span>
                <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">60</span>, <span class="kw">mean</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">sd</span><span class="kw">=</span><span class="fl">0.1</span>), <span class="co"># random intercepts</span>
                <span class="fl">0</span>) <span class="co"># variance of random intercepts</span>


<span class="no">vnames</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>),
            <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"tau_int"</span>, <span class="fl">1</span>:<span class="fl">60</span>),
            <span class="st">"xi1"</span>)

<span class="no">epsvals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5e-2</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1e-2</span>, <span class="fl">4</span>), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">5e-2</span>, <span class="fl">61</span>))

<span class="no">t1.hmc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
<span class="no">f_hmc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/hmc.html">hmc</a></span>(<span class="kw">N</span> <span class="kw">=</span> <span class="no">N</span>, <span class="kw">theta.init</span> <span class="kw">=</span> <span class="no">initvals</span>,
          <span class="kw">epsilon</span> <span class="kw">=</span> <span class="no">epsvals</span>, <span class="kw">L</span> <span class="kw">=</span> <span class="fl">10</span>,
          <span class="kw">logPOSTERIOR</span> <span class="kw">=</span> <span class="no">glmm_bin_posterior</span>,
          <span class="kw">glogPOSTERIOR</span> <span class="kw">=</span> <span class="no">g_glmm_bin_posterior</span>,
          <span class="kw">varnames</span> <span class="kw">=</span> <span class="no">vnames</span>,
          <span class="kw">parallel</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">chains</span><span class="kw">=</span><span class="fl">2</span>,
          <span class="kw">param</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">X</span><span class="kw">=</span><span class="no">X2</span>, <span class="kw">Z</span><span class="kw">=</span><span class="no">Z</span>, <span class="kw">m</span><span class="kw">=</span><span class="fl">60</span>, <span class="kw">q</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">B</span><span class="kw">=</span><span class="fl">5</span>,
                     <span class="kw">nulambda</span><span class="kw">=</span><span class="fl">4</span>, <span class="kw">Alambda</span><span class="kw">=</span><span class="fl">1</span>)  )

<span class="no">t2.hmc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
<span class="no">t2.hmc</span> - <span class="no">t1.hmc</span>
<span class="co">#&gt; Time difference of 1.058857 mins</span></pre></body></html></div>
<p>The acceptance ratio for each of the HMC chains is sufficiently high for an efficient simulation.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">f_hmc</span>$<span class="no">accept</span>/<span class="no">N</span>
<span class="co">#&gt; [1] 0.6635 0.6560</span></pre></body></html></div>
<p>Trace plots provide a visual indication of stationarity. These plots indicate that the MCMC chains are reasonably stationary.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/hmclearn-plots.html">mcmc_trace</a></span>(<span class="no">f_hmc</span>, <span class="kw">burnin</span><span class="kw">=</span><span class="fl">1000</span>, <span class="kw">pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>))</pre></body></html></div>
<p><img src="logistic_mixed_effects_hmclearn_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Since we used QR decomposition to transform <span class="math inline">\(\beta\)</span> prior to fitting via HMC, we need to reverse the transformation to obtain the original parameter scale.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># restore beta from Rstar in QR decomposition</span>
<span class="no">calc_beta</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">theta_param</span>, <span class="no">Rstarinv</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">Rstarinv</span> <span class="kw">%*%</span> <span class="no">theta_param</span>)
}

<span class="co"># reverse qr decomposition</span>
<span class="no">f_hmc2</span> <span class="kw">&lt;-</span> <span class="no">f_hmc</span>
<span class="no">f_hmc2</span>$<span class="no">thetaCombined</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">f_hmc</span>$<span class="no">thetaCombined</span>, <span class="kw">function</span>(<span class="no">xx</span>) {
  <span class="no">xx</span>[, <span class="fl">1</span>:<span class="fl">5</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">xx</span>[, <span class="fl">1</span>:<span class="fl">5</span>], <span class="fl">1</span>, <span class="no">calc_beta</span>, <span class="kw">Rstarinv</span><span class="kw">=</span><span class="no">Rstar_inv</span>))
  <span class="no">xx</span>
})</pre></body></html></div>
<p>The revised summary shows the posterior distribution after transformation back to the original scale.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">f_hmc2</span>)
<span class="co">#&gt; Summary of MCMC simulation</span>
<span class="co">#&gt;                     5%           25%          50%          75%          95%</span>
<span class="co">#&gt; int       -1.296564581 -1.1357598432 -1.014698014 -0.903983213 -0.742646741</span>
<span class="co">#&gt; age       -0.007192108  0.0009555332  0.006483548  0.011851006  0.019406342</span>
<span class="co">#&gt; age_sq    -0.005906520 -0.0051625134 -0.004647281 -0.004151238 -0.003489189</span>
<span class="co">#&gt; urban      0.485203556  0.6092638178  0.692855386  0.779227880  0.899982553</span>
<span class="co">#&gt; liv2       0.620354294  0.7683394702  0.870016188  0.968266676  1.113317581</span>
<span class="co">#&gt; tau_int1  -2.341440894 -1.8136643793 -1.509537184 -1.200503127 -0.801172846</span>
<span class="co">#&gt; tau_int2  -1.290493908 -0.5356467939 -0.086614400  0.383297086  1.188340048</span>
<span class="co">#&gt; tau_int3  -1.080664513 -0.1093969439  0.559479108  1.184089201  2.061886036</span>
<span class="co">#&gt; tau_int4  -0.592836182 -0.0299116153  0.382883576  0.796523298  1.409615096</span>
<span class="co">#&gt; tau_int5  -0.771160722 -0.1794807284  0.196010801  0.589332501  1.162518487</span>
<span class="co">#&gt; tau_int6  -1.301354996 -0.8115924700 -0.466389740 -0.131003091  0.298346863</span>
<span class="co">#&gt; tau_int7  -1.448024350 -0.7564233023 -0.271482775  0.186303476  0.839768558</span>
<span class="co">#&gt; tau_int8  -0.653464776 -0.0632780314  0.337137573  0.717323955  1.258891413</span>
<span class="co">#&gt; tau_int9  -1.505479854 -0.8847823157 -0.403031916  0.034084077  0.669700741</span>
<span class="co">#&gt; tau_int10 -2.046201943 -1.2511002029 -0.760117367 -0.176709489  0.541865946</span>
<span class="co">#&gt; tau_int11 -2.879852801 -2.1357229400 -1.614535326 -1.133669797 -0.351449122</span>
<span class="co">#&gt; tau_int12 -1.268029204 -0.7018865709 -0.275913729  0.156356083  0.778523175</span>
<span class="co">#&gt; tau_int13 -0.904324608 -0.2472281626  0.169786595  0.625397103  1.228381541</span>
<span class="co">#&gt; tau_int14  0.636337738  1.0214485280  1.309811187  1.609496511  2.048037248</span>
<span class="co">#&gt; tau_int15 -1.175552392 -0.5143466228 -0.073304159  0.365716104  1.013684314</span>
<span class="co">#&gt; tau_int16  0.225204032  0.8726165270  1.328010712  1.775907728  2.479651934</span>
<span class="co">#&gt; tau_int17 -1.576765408 -0.8091203406 -0.350277131  0.092962163  0.746417232</span>
<span class="co">#&gt; tau_int18 -0.998384976 -0.4732947566 -0.100654701  0.240417298  0.767944451</span>
<span class="co">#&gt; tau_int19 -0.993959097 -0.3332313424  0.096110664  0.484125152  1.122271357</span>
<span class="co">#&gt; tau_int20 -0.723210285  0.0127656701  0.520470182  1.083860832  1.787865937</span>
<span class="co">#&gt; tau_int21 -1.128954477 -0.4336787014  0.052335150  0.547722241  1.222494036</span>
<span class="co">#&gt; tau_int22 -1.985064335 -1.3253205946 -0.875896725 -0.387054109  0.234467500</span>
<span class="co">#&gt; tau_int23 -1.622721798 -0.9055860617 -0.430028946  0.054320918  0.781134522</span>
<span class="co">#&gt; tau_int24 -2.328150391 -1.5064697367 -0.977985325 -0.481945607  0.332992888</span>
<span class="co">#&gt; tau_int25 -0.450098393 -0.0205792078  0.299520627  0.621933772  1.092769643</span>
<span class="co">#&gt; tau_int26 -1.211027311 -0.4353851336  0.060389796  0.532953640  1.334814305</span>
<span class="co">#&gt; tau_int27 -1.934124345 -1.3133539827 -0.905595688 -0.499979381  0.011923927</span>
<span class="co">#&gt; tau_int28 -1.698276504 -1.1000672624 -0.692455967 -0.309675414  0.177424533</span>
<span class="co">#&gt; tau_int29 -1.257966849 -0.6096819240 -0.220264447  0.199783279  0.772796427</span>
<span class="co">#&gt; tau_int30  0.112435375  0.5608226334  0.863193940  1.199618015  1.656468030</span>
<span class="co">#&gt; tau_int31 -0.175492964  0.3871582555  0.781557887  1.151403503  1.730479760</span>
<span class="co">#&gt; tau_int32 -2.071058179 -1.3941876904 -0.948624626 -0.497805707  0.188342796</span>
<span class="co">#&gt; tau_int33 -1.325368332 -0.5712895634 -0.070863255  0.394721656  1.088647268</span>
<span class="co">#&gt; tau_int34  0.430297927  1.0015231996  1.380633523  1.788388612  2.358275531</span>
<span class="co">#&gt; tau_int35 -0.306841896  0.1687412952  0.534638016  0.871149219  1.398764031</span>
<span class="co">#&gt; tau_int36 -1.297927207 -0.6141788629 -0.166993267  0.338593820  0.962397670</span>
<span class="co">#&gt; tau_int37 -0.528049767  0.2258051219  0.749871329  1.254982739  1.961731292</span>
<span class="co">#&gt; tau_int38 -1.517156343 -0.7299546524 -0.218307349  0.289580150  1.014089203</span>
<span class="co">#&gt; tau_int39 -0.064532895  0.5576710666  0.978261240  1.396080675  1.984390009</span>
<span class="co">#&gt; tau_int40 -0.709434362 -0.1798576469  0.177627137  0.540826447  1.097808668</span>
<span class="co">#&gt; tau_int41 -0.585386458  0.0714907277  0.519031669  0.955393770  1.568844736</span>
<span class="co">#&gt; tau_int42 -1.000224583 -0.1885292415  0.323795773  0.893859212  1.597872662</span>
<span class="co">#&gt; tau_int43  0.132137210  0.6873521328  1.053824346  1.396092657  1.953661920</span>
<span class="co">#&gt; tau_int44 -1.708509189 -1.0989858048 -0.634212295 -0.198704140  0.384923406</span>
<span class="co">#&gt; tau_int45 -1.248898429 -0.6604720356 -0.256132279  0.123312067  0.643481574</span>
<span class="co">#&gt; tau_int46  0.394699089  0.8125164452  1.119053285  1.437215167  1.910349160</span>
<span class="co">#&gt; tau_int47 -0.940826839 -0.1342218509  0.383147617  0.882105868  1.608926272</span>
<span class="co">#&gt; tau_int48  0.014532084  0.5389819484  0.875685556  1.243438371  1.779783219</span>
<span class="co">#&gt; tau_int49 -1.867046733 -1.0684263728 -0.483900013  0.125733198  0.988356793</span>
<span class="co">#&gt; tau_int50 -0.585901611  0.1027010551  0.561976485  0.988696616  1.595334324</span>
<span class="co">#&gt; tau_int51 -0.701744836 -0.1665346057  0.230523376  0.618347932  1.165469767</span>
<span class="co">#&gt; tau_int52 -0.325957495  0.1592210705  0.491922530  0.816258356  1.314677872</span>
<span class="co">#&gt; tau_int53 -1.455951791 -0.7782874039 -0.340170738  0.153919904  0.853936288</span>
<span class="co">#&gt; tau_int54 -2.217315227 -1.3775558835 -0.800239118 -0.224033439  0.545620437</span>
<span class="co">#&gt; tau_int55  0.387709975  0.8899478302  1.243695516  1.616444939  2.199626646</span>
<span class="co">#&gt; tau_int56 -2.129037294 -1.4748795034 -1.044106567 -0.593167013  0.034319396</span>
<span class="co">#&gt; tau_int57 -0.333914278  0.1913105990  0.576816047  0.970011077  1.577417944</span>
<span class="co">#&gt; tau_int58 -2.112754064 -1.1974075676 -0.704689789 -0.161567258  0.627255938</span>
<span class="co">#&gt; tau_int59 -2.011402027 -1.3545734730 -0.913070966 -0.471222374  0.061671348</span>
<span class="co">#&gt; tau_int60 -2.047759690 -1.4114227690 -1.040859631 -0.653435805 -0.125265764</span>
<span class="co">#&gt; xi1       -0.977809009 -0.8032874431 -0.695008997 -0.577744160 -0.421544914</span>
<span class="co">#&gt;                rhat</span>
<span class="co">#&gt; int       0.9997501</span>
<span class="co">#&gt; age       0.9997936</span>
<span class="co">#&gt; age_sq    1.0005994</span>
<span class="co">#&gt; urban     1.0002958</span>
<span class="co">#&gt; liv2      0.9997727</span>
<span class="co">#&gt; tau_int1  0.9997670</span>
<span class="co">#&gt; tau_int2  1.0073116</span>
<span class="co">#&gt; tau_int3  1.0001777</span>
<span class="co">#&gt; tau_int4  1.0036736</span>
<span class="co">#&gt; tau_int5  1.0017437</span>
<span class="co">#&gt; tau_int6  0.9998556</span>
<span class="co">#&gt; tau_int7  1.0016514</span>
<span class="co">#&gt; tau_int8  1.0055147</span>
<span class="co">#&gt; tau_int9  1.0041290</span>
<span class="co">#&gt; tau_int10 1.0052926</span>
<span class="co">#&gt; tau_int11 1.0061871</span>
<span class="co">#&gt; tau_int12 0.9998217</span>
<span class="co">#&gt; tau_int13 1.0059574</span>
<span class="co">#&gt; tau_int14 1.0036926</span>
<span class="co">#&gt; tau_int15 1.0000769</span>
<span class="co">#&gt; tau_int16 1.0011061</span>
<span class="co">#&gt; tau_int17 1.0121262</span>
<span class="co">#&gt; tau_int18 0.9997726</span>
<span class="co">#&gt; tau_int19 0.9997640</span>
<span class="co">#&gt; tau_int20 1.0009161</span>
<span class="co">#&gt; tau_int21 1.0030740</span>
<span class="co">#&gt; tau_int22 1.0095557</span>
<span class="co">#&gt; tau_int23 1.0078287</span>
<span class="co">#&gt; tau_int24 1.0000753</span>
<span class="co">#&gt; tau_int25 1.0001918</span>
<span class="co">#&gt; tau_int26 1.0030752</span>
<span class="co">#&gt; tau_int27 1.0012596</span>
<span class="co">#&gt; tau_int28 0.9999915</span>
<span class="co">#&gt; tau_int29 0.9998591</span>
<span class="co">#&gt; tau_int30 1.0082540</span>
<span class="co">#&gt; tau_int31 1.0000167</span>
<span class="co">#&gt; tau_int32 0.9999988</span>
<span class="co">#&gt; tau_int33 1.0022421</span>
<span class="co">#&gt; tau_int34 0.9998012</span>
<span class="co">#&gt; tau_int35 1.0052123</span>
<span class="co">#&gt; tau_int36 0.9997637</span>
<span class="co">#&gt; tau_int37 1.0045017</span>
<span class="co">#&gt; tau_int38 1.0261785</span>
<span class="co">#&gt; tau_int39 0.9997732</span>
<span class="co">#&gt; tau_int40 0.9997519</span>
<span class="co">#&gt; tau_int41 1.0033344</span>
<span class="co">#&gt; tau_int42 1.0021076</span>
<span class="co">#&gt; tau_int43 1.0023943</span>
<span class="co">#&gt; tau_int44 1.0026532</span>
<span class="co">#&gt; tau_int45 1.0001163</span>
<span class="co">#&gt; tau_int46 1.0001982</span>
<span class="co">#&gt; tau_int47 1.0004910</span>
<span class="co">#&gt; tau_int48 0.9997517</span>
<span class="co">#&gt; tau_int49 1.0005925</span>
<span class="co">#&gt; tau_int50 1.0041356</span>
<span class="co">#&gt; tau_int51 1.0018021</span>
<span class="co">#&gt; tau_int52 1.0017332</span>
<span class="co">#&gt; tau_int53 1.0000734</span>
<span class="co">#&gt; tau_int54 1.0010943</span>
<span class="co">#&gt; tau_int55 1.0045624</span>
<span class="co">#&gt; tau_int56 1.0003279</span>
<span class="co">#&gt; tau_int57 0.9999159</span>
<span class="co">#&gt; tau_int58 1.0038792</span>
<span class="co">#&gt; tau_int59 1.0016117</span>
<span class="co">#&gt; tau_int60 1.0003772</span>
<span class="co">#&gt; xi1       0.9997503</span></pre></body></html></div>
<p>We create trace plots on the transformed simulation data.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/hmclearn-plots.html">mcmc_trace</a></span>(<span class="no">f_hmc2</span>, <span class="kw">burnin</span><span class="kw">=</span><span class="fl">1000</span>, <span class="kw">pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>))</pre></body></html></div>
<p><img src="logistic_mixed_effects_hmclearn_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
</div>
</div>
<div id="frequentist-model" class="section level1">
<h1 class="hasAnchor">
<a href="#frequentist-model" class="anchor"></a>Frequentist model</h1>
<p>To compare results, we first fit a logistic mixed effects model using the frequentist package <strong>lme4</strong> (Bates et. al. 2015).</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lme4</span>)
<span class="co">#&gt; Loading required package: Matrix</span>

<span class="no">f</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(<span class="no">use</span> ~ <span class="no">age</span> + <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span>(<span class="no">age</span>^<span class="fl">2</span>) + <span class="no">urban</span> + <span class="no">liv2</span> + (<span class="fl">1</span> <span class="kw">|</span> <span class="no">district</span>),
           <span class="kw">data</span><span class="kw">=</span><span class="no">Contraception</span>, <span class="kw">family</span><span class="kw">=</span><span class="no">binomial</span>,
           <span class="kw">control</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">glmerControl</a></span>(<span class="kw">optCtrl</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">maxfun</span><span class="kw">=</span><span class="fl">20000</span>)))
<span class="co">#&gt; Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, : Model is nearly unidentifiable: very large eigenvalue</span>
<span class="co">#&gt;  - Rescale variables?</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">f</span>)
<span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span>
<span class="co">#&gt;   Approximation) [glmerMod]</span>
<span class="co">#&gt;  Family: binomial  ( logit )</span>
<span class="co">#&gt; Formula: use ~ age + I(age^2) + urban + liv2 + (1 | district)</span>
<span class="co">#&gt;    Data: Contraception</span>
<span class="co">#&gt; Control: glmerControl(optCtrl = list(maxfun = 20000))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span>
<span class="co">#&gt;   2385.2   2418.6  -1186.6   2373.2     1928 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Scaled residuals: </span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -1.8151 -0.7620 -0.4619  0.9518  3.1033 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span>
<span class="co">#&gt;  district (Intercept) 0.2247   0.474   </span>
<span class="co">#&gt; Number of obs: 1934, groups:  district, 60</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="co">#&gt; (Intercept) -1.0063737  0.1691107  -5.951 2.67e-09 ***</span>
<span class="co">#&gt; age          0.0062561  0.0078848   0.793    0.428    </span>
<span class="co">#&gt; I(age^2)    -0.0046353  0.0007207  -6.432 1.26e-10 ***</span>
<span class="co">#&gt; urbanY       0.6929220  0.1206566   5.743 9.31e-09 ***</span>
<span class="co">#&gt; liv2         0.8603821  0.1483014   5.802 6.57e-09 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Correlation of Fixed Effects:</span>
<span class="co">#&gt;          (Intr) age    I(g^2) urbanY</span>
<span class="co">#&gt; age       0.529                     </span>
<span class="co">#&gt; I(age^2) -0.533 -0.506              </span>
<span class="co">#&gt; urbanY   -0.259 -0.032  0.020       </span>
<span class="co">#&gt; liv2     -0.801 -0.565  0.345  0.094</span>
<span class="co">#&gt; convergence code: 0</span>
<span class="co">#&gt; Model is nearly unidentifiable: very large eigenvalue</span>
<span class="co">#&gt;  - Rescale variables?</span></pre></body></html></div>
<div class="sourceCode" id="cb11"><html><body><pre class="r">
<span class="no">freqvals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/lme4/man/fixef.html">fixef</a></span>(<span class="no">f</span>)),
              <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/lme4/man/ranef.html">ranef</a></span>(<span class="no">f</span>)$<span class="no">district</span>[, <span class="fl">1</span>]),
              <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/lme4/man/VarCorr.html">VarCorr</a></span>(<span class="no">f</span>)[<span class="fl">1</span>]))))</pre></body></html></div>
<p>Histograms of the posterior distribution show that Bayesian parameter estimates align with frequentist estimates. The <em>cols</em> parameter specifies the parameters to be displayed in <em>diagplots</em>, based on the order provided to the <em>hmc</em> function.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="../reference/diagplots.html">diagplots</a></span>(<span class="no">f_hmc2</span>, <span class="kw">burnin</span><span class="kw">=</span><span class="fl">1000</span>,
          <span class="kw">actual.mu</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">freqvals</span>[<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>)], <span class="no">freqvals</span>[<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">freqvals</span>)]),
          <span class="kw">cols</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">initvals</span>)))
<span class="co">#&gt; $histogram</span></pre></body></html></div>
<p><img src="logistic_mixed_effects_hmclearn_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
</div>
<div id="source" class="section level1">
<h1 class="hasAnchor">
<a href="#source" class="anchor"></a>Source</h1>
<p>Steele, F., Diamond, I. And Amin, S. (1996). Immunization uptake in rural Bangladesh: a multilevel analysis. <em>Journal of the Royal Statistical Society</em>, Series A (159): 289-299.</p>
<p></p>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<p>Bates, D., M"{a}chler, M., Bolker, B., &amp; Walker, S. (2015). Fitting linear mixed-effects models using lme4. <em>Journal of Statistical Software</em> 67(1)</p>
<p>Bates, D., M"{a}chler, M., &amp; Bolker, B. (2014). mlmRev: Examples from multilevel modelling software review. <em>R package version, 1</em>.</p>
<p>Agresti, A. (2015). <em>Foundations of linear and generalized linear models</em>. John Wiley &amp; Sons. ISBN: 978-1-118-73003-4</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Samuel Thomas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
