<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>hmclearn package:  Logistic Mixed Effects Regression Example • hmclearn</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="hmclearn package:  Logistic Mixed Effects Regression Example">
<meta property="og:description" content="hmclearn">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hmclearn</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/linear_mixed_effects_hmclearn.html">hmclearn package:  Linear Mixed Effects Regression Example</a>
    </li>
    <li>
      <a href="../articles/linear_regression_hmclearn.html">hmclearn package:  Linear Regression Example</a>
    </li>
    <li>
      <a href="../articles/logistic_mixed_effects_hmclearn.html">hmclearn package:  Logistic Mixed Effects Regression Example</a>
    </li>
    <li>
      <a href="../articles/logistic_regression_hmclearn.html">hmclearn:  Logistic Regression Example</a>
    </li>
    <li>
      <a href="../articles/poisson_regression_hmclearn.html">hmclearn:  Poisson Regression Example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>hmclearn package: Logistic Mixed Effects Regression Example</h1>
                        <h4 class="author">Samuel Thomas</h4>
            
            <h4 class="date">2020-05-30</h4>
      
      
      <div class="hidden name"><code>logistic_mixed_effects_hmclearn.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette demonstrates fitting a Logistic mixed effects regression model via Hamiltonian Monte Carlo (HMC) using the <strong>hmclearn</strong> package.</p>
<p>For a mixed effects model with binary response, we let</p>
<p><span class="math display">\[
p = Pr(Y = 1 | X, Z) = [1 + e^{-X\beta-Zu}]^{-1}
\]</span> or</p>
<p><span class="math display">\[
\begin{aligned}
\text{logit}[P(y = 1 | u)] &amp;= X\beta + Zu \\
u &amp;\sim N(0, G)
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">hmclearn</span>)</pre></body></html></div>
</div>
<div id="logistic-mixed-effects-model-example-data" class="section level1">
<h1 class="hasAnchor">
<a href="#logistic-mixed-effects-model-example-data" class="anchor"></a>Logistic Mixed Effects Model Example Data</h1>
<p>The user must define provide the design matrix directly for use in <strong>hmclearn</strong>. Our first step is to load the data and store the fixed effect design matrix <span class="math inline">\(X\)</span>, random effects design matrix <span class="math inline">\(Z\)</span>, and dependent variable vector <span class="math inline">\(y\)</span>.</p>
<p>We load drug Contraception data (Bates, et. al. 2014) and create the design matrices <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span> and dependent vector <span class="math inline">\(y\)</span>. For this model, the random effects design matrix <span class="math inline">\(Z\)</span> is specified for a random intercept model.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">Contraception</span> <span class="kw">&lt;-</span> <span class="kw pkg">mlmRev</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/mlmRev/man/Contraception.html">Contraception</a></span>

<span class="no">Contraception</span>$<span class="no">liv2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">Contraception</span>$<span class="no">livch</span> <span class="kw">==</span> <span class="st">"0"</span>, <span class="fl">0</span>, <span class="fl">1</span>)

<span class="co">##########</span>
<span class="co"># block diagonal</span>
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">Contraception</span>)), <span class="no">Contraception</span>$<span class="no">district</span>)
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">Zi.lst</span>, <span class="no">as.matrix</span>)
<span class="no">Z</span> <span class="kw">&lt;-</span> <span class="kw pkg">Matrix</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/bdiag.html">bdiag</a></span>(<span class="no">Zi.lst</span>)
<span class="no">Z</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Z</span>)

<span class="no">urban</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">Contraception</span>$<span class="no">urban</span> <span class="kw">==</span> <span class="st">"Y"</span>, <span class="fl">1</span>, <span class="fl">0</span>)

<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fl">1</span>, <span class="no">Contraception</span>$<span class="no">age</span>, <span class="no">Contraception</span>$<span class="no">age</span>^<span class="fl">2</span>, <span class="no">urban</span>, <span class="no">Contraception</span>$<span class="no">liv2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"int"</span>, <span class="st">"age"</span>, <span class="st">"age_sq"</span>, <span class="st">"urban"</span>, <span class="st">"liv2"</span>)
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">Contraception</span>$<span class="no">use</span> <span class="kw">==</span> <span class="st">"Y"</span>, <span class="fl">1</span>, <span class="fl">0</span>)</pre></body></html></div>
<div id="qr-decomposition-of-design-matrix" class="section level2">
<h2 class="hasAnchor">
<a href="#qr-decomposition-of-design-matrix" class="anchor"></a>QR decomposition of design matrix</h2>
<p>To facilitate a more efficient fitting of the model, we apply QR decomposition to the fixed effects design matrix <span class="math inline">\(X\)</span>.</p>
<p>Let <span class="math inline">\(\theta = R^*\beta\)</span> (below). The HMC estimates <span class="math inline">\(\theta\)</span>, from which we can use the deterministic formula to determine <span class="math inline">\(\beta\)</span></p>
<p><span class="math display">\[
\begin{aligned}
X &amp;= Q^* R^* \\
Q^* &amp;= Q \cdot \sqrt{n-1} \\
R^* &amp;= \frac{1}{\sqrt{n-1}}R \\
X\beta &amp;= Q^* R^* \beta \\
\beta &amp;= R^{*^{-1}}\theta
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">xqr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qr.html">qr</a></span>(<span class="no">X</span>)
<span class="no">Q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qraux.html">qr.Q</a></span>(<span class="no">xqr</span>)
<span class="no">R</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/qraux.html">qr.R</a></span>(<span class="no">xqr</span>)

<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X</span>)
<span class="no">X2</span> <span class="kw">&lt;-</span> <span class="no">Q</span> * <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">n</span>-<span class="fl">1</span>)
<span class="no">Rstar</span> <span class="kw">&lt;-</span> <span class="no">R</span> / <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">n</span>-<span class="fl">1</span>)
<span class="no">Rstar_inv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span>(<span class="no">Rstar</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X2</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"int"</span>, <span class="st">"age"</span>, <span class="st">"age_sq"</span>, <span class="st">"urban"</span>, <span class="st">"liv2"</span>)

<span class="co"># new intercept from QR decomposition</span>
<span class="no">diagval</span> <span class="kw">&lt;-</span> <span class="no">X2</span>[<span class="fl">1</span>,<span class="fl">1</span>]


<span class="co">##########</span>
<span class="co"># block diagonal</span>
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">diagval</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">Contraception</span>)), <span class="no">Contraception</span>$<span class="no">district</span>)
<span class="no">Zi.lst</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">Zi.lst</span>, <span class="no">as.matrix</span>)
<span class="no">Z2</span> <span class="kw">&lt;-</span> <span class="kw pkg">Matrix</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/bdiag.html">bdiag</a></span>(<span class="no">Zi.lst</span>)
<span class="no">Z2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Z2</span>)</pre></body></html></div>
</div>
<div id="likelihood-derivation" class="section level2">
<h2 class="hasAnchor">
<a href="#likelihood-derivation" class="anchor"></a>Likelihood Derivation</h2>
<p>First, we derive the likelihood for our logistic mixed effects regression model.</p>
<p><span class="math display">\[
\begin{aligned}
p(y | X, Z, \beta, u) &amp;= \prod_{i=1}^n\prod_{j=1}^m \left(\frac{1}{1 + e^{-X_{i}\beta - Z_{ij}u_i}}\right)^{y_{ij}} \left(\frac{e^{-X_i\beta - Z_{ij}u_i}}{1 + e^{-X_{i}\beta - Z_{ij}u_i}}\right)^{1-y_{ij}} \\
\log p(y|X,Z,\beta,u) &amp;= \sum_{i=1}^n\sum_{j=1}^m -y_{ij}\log (1 + e^{-X_i\beta - Z_{ij}u_i}) + (1 - y_{ij})\log e^{-X_i\beta - Z_{ij}u_i} \\
&amp;- (1-y_{ij})\log(1 + e^{-X_i\beta - Z_{ij}u_i}) \\
&amp;= \sum_{i=1}^n \sum_{j=1}^m -y_{ij}\log (1 + e^{-X_i\beta - Z_{ij}u_i}) - (1-y_{ij})(X_{ij}\beta + Z_{ij}u_i) \\
&amp;- (1-y_{ij})\log(1 + e^{-X_i\beta - Z_{ij}u_i}) \\
&amp;= \sum_{i=1}^n\sum_{j=1}^m -y_{ij}\log(1 + e^{-X_i\beta-Z_{ij}u_i}) - (X_{ij}\beta + Z_{ij}u_i - \log(1+e^{-X_i\beta-Z_{ij}u_i})) \\
&amp;+ y_{ij}(X_{ij}\beta + Z_{ij}u_i + \log(1 + e^{-X_i\beta - Z_{ij}u_i})) \\
&amp;=\sum_{i=1}^n \sum_{j=1}^m -(1 - y_{ij})(X_{i}\beta + Z_{ij}u_i) - \log(1 + e^{-X_{i}\beta - Z_{ij}u_i}) \\
&amp;= -(1 - y)^T(X\beta + Zu) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}u_i)})
\end{aligned}
\]</span></p>
</div>
</div>
<div id="priors" class="section level1">
<h1 class="hasAnchor">
<a href="#priors" class="anchor"></a>Priors</h1>
<p>Priors are needed for our parameters <span class="math inline">\(\beta\)</span> and <span class="math inline">\(G\)</span> to formulate the posterior.</p>
<p>We set a multivariate Normal prior for <span class="math inline">\(\beta\)</span></p>
<p><span class="math display">\[
\begin{aligned}
\beta &amp;\sim N(0, \Sigma_\beta) \\
&amp;\sim N(0, \sigma_\beta^2I)
\end{aligned}
\]</span></p>
<p>with pdf</p>
<p><span class="math display">\[
\begin{aligned}
p(\beta) &amp;= \frac{1}{\sqrt{\lvert 2\pi \Sigma_\beta \rvert }}e^{-\frac{1}{2}\beta^T \Sigma_\beta^{-1}\beta} \\
\log p(\beta) &amp;= -\frac{1}{2}\log(2\pi \lvert \Sigma_\beta \rvert) - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;\propto -\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta.
\end{aligned}
\]</span></p>
</div>
<div id="parameterization-for-g" class="section level1">
<h1 class="hasAnchor">
<a href="#parameterization-for-g" class="anchor"></a>Parameterization for <span class="math inline">\(G\)</span>
</h1>
<p>The parameterization approach for this model uses a strategy recommended by Betancourt, Girolami (2013) to facilitate more efficient sampling in HMC.</p>
<p>Further, the uniform parameterization of the variance parameters is replaced by a half-t family of distributions per Gelman (2006), Prior distributions for Variance parameters in hierarchical models. This parameterization is well-behaved around 0, in contrast to inverse gamma, and provides flexibility for more informed priors than a uniform distribution.</p>
<p>We select a parameterization of <span class="math inline">\(G\)</span> such that the likelihood and its gradient can be derived for HMC. To this end, we uses LDL decomposition of <span class="math inline">\(G\)</span> to form a flexibile parameterization that can easily handle restrictions (Chan, Jelizkov 2009).</p>
<p><span class="math display">\[
\begin{aligned}
u &amp;\sim N(0, G)  \\
G &amp;= L D L^T \\
&amp;= L D^{1/2} D^{1/2} L^T \\
\end{aligned}
\]</span></p>
<p>Let <span class="math inline">\(\lambda_k\)</span> where <span class="math inline">\(k = 1, ... p\)</span> denote the diagonal entries of <span class="math inline">\(D^{1/2}\)</span> and let <span class="math inline">\(a_{kj}\)</span> where <span class="math inline">\(1 \leq j &lt; k \leq p\)</span> denote free elements of lower unitrangular matrix <span class="math inline">\(L\)</span></p>
<p><span class="math display">\[
D^{1/2} := 
\begin{pmatrix}
\lambda_1 &amp; 0 &amp; ... &amp; 0 \\
0 &amp; \lambda_2 &amp; 0 ... &amp; 0 \\
... &amp; ... &amp; ... &amp; ... \\
0 &amp; 0 &amp; ... &amp; \lambda_p
\end{pmatrix}, 
L :=
\begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; ... &amp; 0 \\
a_{21} &amp; 1 &amp; 0 &amp; ... &amp; 0 \\
a_{31} &amp; a_{32} &amp; 1 &amp; ... &amp; ... \\
... &amp; ... &amp; ... &amp; ... &amp; ... \\
a_{p1} &amp; a_{p2} &amp; ... &amp; ... &amp; 1 \\
\end{pmatrix}
\]</span></p>
<p>Also define <span class="math inline">\(\lambda := (\lambda_1, ..., \lambda_p)^T\)</span> and <span class="math inline">\(a_k := (a_{k1}, ..., a_{k, k-1})^T\)</span> and <span class="math inline">\(a := (a_2^T, ..., a_p^T)^T\)</span></p>
<p>Consider priors where <span class="math inline">\(k = 1...p\)</span>. The prior for <span class="math inline">\(\lambda_k\)</span> is half-t per Gelman (2006).</p>
<p><span class="math display">\[
\begin{aligned}
p(\lambda_k) &amp;\sim \left(1 + \frac{1}{\nu}\left(\frac{\lambda_k}{A} \right)^2 \right)^{-(\nu+1)/2} \\
a|\lambda &amp;\sim N(a_0, A_0)
\end{aligned}
\]</span></p>
<p>The hyperparameter <span class="math inline">\(a_0\)</span> does not need to be zero, and <span class="math inline">\(A_0\)</span> can be correlated and may depend on <span class="math inline">\(\lambda\)</span>. In this model, we define <span class="math inline">\(a\)</span> independent of <span class="math inline">\(\lambda\)</span>.</p>
<p>Per Betancourt, Girolami (2013), we re-parameterize <span class="math inline">\(u\)</span> using a standard normal parameterization we define as <span class="math inline">\(\tau = (\tau_1, ..., \tau_q)\)</span>. Here, <span class="math inline">\(u\)</span> is a deterministic function of <span class="math inline">\(G\)</span> and <span class="math inline">\(\tau\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
\tau &amp;\sim N(0, I_q) \\
u &amp;:= L D^{1/2} \tau \\
&amp;\sim N(0, LD^{1/2} I (L D^{1/2})^T) \\
&amp;\sim N(0, L D^{1/2} D^{1/2} L^T) \\
&amp;\sim N(0, G)
\end{aligned}
\]</span></p>
<p>The distribution of <span class="math inline">\(u\)</span> therefore does not change with this parameterization. The intent of our re-parameterization is to allow <span class="math inline">\(G\)</span> and <span class="math inline">\(\tau\)</span> to be largely independent in the MCMC sampling.</p>
<div id="log-posterior-derivation" class="section level2">
<h2 class="hasAnchor">
<a href="#log-posterior-derivation" class="anchor"></a>Log posterior derivation</h2>
<p>Now that we have the log likelihood and priors specified, we can derive the log posterior.</p>
<p><span class="math display">\[
\begin{aligned}
p(\beta, u, G | y, X, Z) &amp;\propto p(y | \beta, u, G)  p(\beta, u, G) \\
&amp;\propto p(y|\beta, u, G) p(\beta) p(u|G) p(G) \\
\log p(\beta, u, G | y, X, Z) &amp;\propto \log p(y|\beta, u, G) + \log p(\beta) + \log p(u|G) + \log p(G)
\end{aligned}
\]</span></p>
<p>The log posterior is the sum of the log likelihood and the log of the prior for <span class="math inline">\(\beta\)</span>.</p>
<p>We have hyperpriors <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(a\)</span> for <span class="math inline">\(G\)</span>. Also, we use a half-t prior for variance parameters per Gelman (2006).</p>
<p><span class="math display">\[
\begin{aligned}
p(\lambda_k) &amp;\sim \left(1 + \frac{1}{\nu}\left(\frac{\lambda_k}{A} \right)^2 \right)^{-(\nu+1)/2} \\
p_{\xi_k}(\xi_k) &amp;= p_{\lambda_k}(g^{-1}(\xi_k)) \left\lvert \frac{d\lambda_k}{d\xi_k}  \right\rvert \\
&amp;= p_{\lambda_k} (e^{\xi_k})\lvert e^{\xi_k}\rvert \\
&amp;\propto  \left(1 + \frac{1}{\nu}\left(\frac{e^{\xi_k}}{A} \right)^2 \right)^{-(\nu+1)/2} e^{\xi_k}\\
&amp;\propto \left(1 + \frac{1}{\nu}\left(\frac{e^{2\xi_k}}{A^2} \right) \right)^{-(\nu+1)/2} e^{\xi_k}\\
\log p(\xi_k) &amp;\propto -\frac{\nu+1}{2}\log\left(1 + \frac{1}{\nu}\left(\frac{e^{2\xi_k}}{A^2} \right) \right) + \xi_k \\
\frac{\partial}{\partial\xi_k}\log p(\xi_k) &amp;\propto -\frac{\nu+1}{2}\frac{1}{1 + \frac{1}{\nu}\left( \frac{e^{2\xi_k}}{A^2} \right)}\frac{2e^{2\xi_k}}{\nu A^2} + 1 \\
&amp;\propto -(\nu+1)\frac{1}{1 + \nu A^2 e^{-2\xi_k}} + 1
\end{aligned}
\]</span></p>
<p>We assign a relatively uniformative prior for <span class="math inline">\(a\)</span></p>
<p><span class="math display">\[
\begin{aligned}
a_k &amp;\sim N(0, A) \\
p(a_k) &amp;\propto \lvert A  \rvert^{-1/2} e^{-\frac{1}{2} a_k^T A^{-1} a_k} \\
\log p(a_k) &amp;\propto -\frac{1}{2}a_k^T A^{-1} a_k
\end{aligned}
\]</span></p>
<p>The gradient with respect to <span class="math inline">\(a\)</span>:</p>
<p>Note that the following are equivalent</p>
<p><span class="math display">\[
\begin{aligned}
L D^{1/2}\tau = D^{1/2} \tau + \widetilde{T} a
\end{aligned}
\]</span></p>
<p>Therefore, the portion of the log likelihood dependent on <span class="math inline">\(a\)</span> becomes</p>
<p><span class="math display">\[
\begin{aligned}
l(a, ..) &amp;\propto -(1 - y)^T(X\beta + ZLD^{1/2}\tau) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}LD^{1/2}\tau_j)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
&amp;\propto -(1 - y)^T Z\widetilde{T} - \left(\frac{e^{-(X\beta + ZLD^{1/2}\tau)}}{1 + e^{-(X\beta + ZLD^{1/2}\tau)}}\right)^T  Z\widetilde{T} - A^{-1}a
\end{aligned}
\]</span></p>
<p>Finally, we write the full log posterior</p>
<p>Note: we use <span class="math inline">\(A_\xi\)</span> and <span class="math inline">\(A_a\)</span> to distinguish between hyperpriors for <span class="math inline">\(\xi\)</span> and for <span class="math inline">\(a\)</span></p>
<p><span class="math display">\[
\begin{aligned}
\log p(\beta, u, G | y, X, Z) &amp;\propto \log p(y|\beta, u, G) + \log p(\beta) + \log p(u|G) + \log p(G) \\
\log p(\beta, \gamma, \tau, \xi_1...\xi_q,a | y, X, Z) &amp;\propto \log p(y | \beta, \tau, \gamma, \xi, a) + \log p(\beta) + \log p(\gamma)+ \log p(\tau) + \log p(\xi) + \log p(a) \\
&amp;\propto  -(1 - y)^T(X\beta + Zu) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}u_i)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
&amp;\propto  -(1 - y)^T(X\beta + ZLD^{1/2}\tau) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}LD^{1/2}\tau_j)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
\end{aligned}
\]</span></p>
<p>The gradient of the log posterior must be derived for the leapfrog function</p>
<p><span class="math display">\[
\begin{aligned}
\log p(\beta, \gamma, \tau, \xi_1...\xi_q,a | y, X, Z) &amp;\propto  -(1 - y)^T(X\beta + ZLD^{1/2}\tau) - \log(1 + e^{-\sum_{i=1}^n \sum_{j=1}^m (X_i\beta + Z_{ij}LD^{1/2}\tau_j)}) \\
&amp;-\frac{1}{2}\log \lvert\Sigma_\beta\rvert - \frac{1}{2}\beta^T \Sigma_\beta^{-1} \beta \\
&amp;-\sum_{k=1}^q \left(\frac{\nu_{\lambda_k}+1}{2}\log\left(1 + \frac{1}{\nu_{\lambda_k}} 
\frac{e^{2\xi_k}}{A_{\lambda_k}^2}\right)+ \xi_k\right)\\
&amp;-\frac{1}{2} a^T A^{-1} a -\frac{1}{2} \tau^T \tau\\
\frac{\partial l}{\partial\beta} &amp;\propto -(1-y)^T X + \left(\frac{e^{-(X\beta + Zu)}}{1 + e^{-(X\beta + Zu)}}\right)^T X - \Sigma_\beta^{-1}\beta\\
\frac{\partial l}{\partial \tau} &amp;\propto -(1-y)^T ZLD^{1/2} + \left(\frac{e^{-(X\beta + Zu)}}{1 + e^{-(X\beta + Zu)}}\right)^T ZLD^{1/2} - \tau\\
\frac{\partial l}{\partial \xi_k} &amp;= -(1-y)^T ZLJ^{kk}\tau + \left(\frac{e^{-(X\beta + Zu)}}{1 + e^{-(X\beta + Zu)}}\right)^T ZLJ^{kk}\tau- (\nu_{\lambda_k}+1)\frac{1}{1 + \nu_{\lambda_k}A_{\lambda_k}^2 e^{-2\xi_k}}+1 \\
\frac{\partial l}{\partial a} &amp;= -(1 - y)^T Z\widetilde{T} - \left(\frac{e^{-(X\beta + ZLD^{1/2}\tau)}}{1 + e^{-(X\beta + ZLD^{1/2}\tau)}}\right)^T  Z\widetilde{T} - A^{-1}a
\end{aligned}
\]</span></p>
<p>Run HMC for logistic regression model using QR decomposed design matrices</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">N</span> <span class="kw">&lt;-</span> <span class="fl">2e3</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">412</span>)
<span class="no">initvals</span><span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fl">5</span>), <span class="co"># fixed effects</span>
                <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">60</span>, <span class="kw">mean</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">sd</span><span class="kw">=</span><span class="fl">0.1</span>), <span class="co"># random intercepts</span>
                <span class="fl">0</span>) <span class="co"># variance of random intercepts</span>


<span class="no">vnames</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>),
            <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"tau_int"</span>, <span class="fl">1</span>:<span class="fl">60</span>),
            <span class="st">"xi1"</span>)

<span class="no">epsvals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5e-2</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1e-2</span>, <span class="fl">4</span>), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">5e-2</span>, <span class="fl">61</span>))

<span class="no">t1.hmc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
<span class="no">f_hmc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/hmc.html">hmc</a></span>(<span class="kw">N</span> <span class="kw">=</span> <span class="no">N</span>, <span class="kw">theta.init</span> <span class="kw">=</span> <span class="no">initvals</span>,
             <span class="kw">epsilon</span> <span class="kw">=</span> <span class="no">epsvals</span>, <span class="kw">L</span> <span class="kw">=</span> <span class="fl">10</span>,
             <span class="kw">logPOSTERIOR</span> <span class="kw">=</span> <span class="no">glmm_bin_posterior</span>,
             <span class="kw">glogPOSTERIOR</span> <span class="kw">=</span> <span class="no">g_glmm_bin_posterior</span>,
             <span class="kw">varnames</span> <span class="kw">=</span> <span class="no">vnames</span>,
             <span class="kw">parallel</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">chains</span><span class="kw">=</span><span class="fl">2</span>,
             <span class="kw">param</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">X</span><span class="kw">=</span><span class="no">X2</span>, <span class="kw">Z</span><span class="kw">=</span><span class="no">Z2</span>, <span class="kw">n</span><span class="kw">=</span><span class="fl">60</span>, <span class="kw">nrandom</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">sig2beta</span><span class="kw">=</span><span class="fl">5</span>,
                        <span class="kw">nuxi</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">Axi</span><span class="kw">=</span><span class="fl">25</span>)  )


<span class="no">t2.hmc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
<span class="no">t2.hmc</span> - <span class="no">t1.hmc</span>
<span class="co">#&gt; Time difference of 1.047306 mins</span></pre></body></html></div>
<p>The acceptance ratio for each of the HMC chains is sufficiently high for an efficient simulation.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">f_hmc</span>$<span class="no">accept</span>/<span class="no">N</span>
<span class="co">#&gt; [1] 0.6500 0.6585</span></pre></body></html></div>
<p>Trace plots provide a visual indication of stationarity. These plots indicate that the MCMC chains are reasonably stationary.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/hmclearn-plots.html">mcmc_trace</a></span>(<span class="no">f_hmc</span>, <span class="kw">burnin</span><span class="kw">=</span><span class="fl">1000</span>, <span class="kw">pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>))</pre></body></html></div>
<p><img src="logistic_mixed_effects_hmclearn_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Since we used QR decomposition to transform <span class="math inline">\(\beta\)</span> prior to fitting via HMC, we need to reverse the transformation to obtain the original parameter scale.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># restore beta from Rstar in QR decomposition</span>
<span class="no">calc_beta</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">theta_param</span>, <span class="no">Rstarinv</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">Rstarinv</span> <span class="kw">%*%</span> <span class="no">theta_param</span>)
}

<span class="co"># reverse qr decomposition</span>
<span class="no">f_hmc2</span> <span class="kw">&lt;-</span> <span class="no">f_hmc</span>
<span class="no">f_hmc2</span>$<span class="no">thetaCombined</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">f_hmc</span>$<span class="no">thetaCombined</span>, <span class="kw">function</span>(<span class="no">xx</span>) {
  <span class="no">xx</span>[, <span class="fl">1</span>:<span class="fl">5</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">xx</span>[, <span class="fl">1</span>:<span class="fl">5</span>], <span class="fl">1</span>, <span class="no">calc_beta</span>, <span class="kw">Rstarinv</span><span class="kw">=</span><span class="no">Rstar_inv</span>))
  <span class="no">xx</span>
})</pre></body></html></div>
<p>The revised summary shows the posterior distribution after transformation back to the original scale.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">f_hmc2</span>)
<span class="co">#&gt; Summary of MCMC simulation</span>
<span class="co">#&gt;                   2.5%            5%          25%          50%          75%</span>
<span class="co">#&gt; int       -1.370411124 -1.3029818235 -1.138541617 -1.020862540 -0.898903655</span>
<span class="co">#&gt; age       -0.009158601 -0.0069282094  0.000555841  0.006448721  0.011632398</span>
<span class="co">#&gt; age_sq    -0.006094587 -0.0058335800 -0.005103874 -0.004640468 -0.004148154</span>
<span class="co">#&gt; urban      0.447888386  0.4858771707  0.603241698  0.687742089  0.772536518</span>
<span class="co">#&gt; liv2       0.553883748  0.6075808166  0.761264290  0.865016949  0.959179977</span>
<span class="co">#&gt; tau_int1   0.662022520  0.7585477003  1.164117420  1.461946139  1.803943662</span>
<span class="co">#&gt; tau_int2  -1.356526125 -1.0897663565 -0.437611359  0.036633277  0.506768418</span>
<span class="co">#&gt; tau_int3  -2.208789869 -1.8965063855 -1.146904169 -0.510224630  0.097900372</span>
<span class="co">#&gt; tau_int4  -1.492102616 -1.3276461414 -0.755724698 -0.359983971  0.008367309</span>
<span class="co">#&gt; tau_int5  -1.421333195 -1.1858423894 -0.603405925 -0.240474778  0.140886813</span>
<span class="co">#&gt; tau_int6  -0.429351951 -0.2706762440  0.165893671  0.468563137  0.822853701</span>
<span class="co">#&gt; tau_int7  -1.184164923 -0.9269447430 -0.253789739  0.231956411  0.728564621</span>
<span class="co">#&gt; tau_int8  -1.405007652 -1.2285604879 -0.682836877 -0.294528639  0.089823009</span>
<span class="co">#&gt; tau_int9  -0.830821029 -0.6106162283  0.013992106  0.440168094  0.877945342</span>
<span class="co">#&gt; tau_int10 -0.970104622 -0.6293773898  0.118502827  0.708327751  1.248635317</span>
<span class="co">#&gt; tau_int11  0.014045551  0.2944845102  1.050011647  1.610130578  2.112592364</span>
<span class="co">#&gt; tau_int12 -0.961714252 -0.7616454843 -0.217601900  0.192941467  0.610219859</span>
<span class="co">#&gt; tau_int13 -1.463316593 -1.2455071242 -0.624057168 -0.178818607  0.242933010</span>
<span class="co">#&gt; tau_int14 -2.245314317 -2.1035636178 -1.613941413 -1.324389564 -1.032599204</span>
<span class="co">#&gt; tau_int15 -1.257106869 -1.0181100277 -0.351515709  0.057638809  0.475301010</span>
<span class="co">#&gt; tau_int16 -2.687552022 -2.4781234927 -1.823775691 -1.397751125 -0.946569648</span>
<span class="co">#&gt; tau_int17 -0.857179591 -0.6955145622 -0.068602258  0.359851494  0.803621853</span>
<span class="co">#&gt; tau_int18 -0.890097922 -0.7158190478 -0.236468597  0.108416380  0.470683432</span>
<span class="co">#&gt; tau_int19 -1.356372938 -1.1434853055 -0.544065165 -0.136456155  0.260235291</span>
<span class="co">#&gt; tau_int20 -1.978773409 -1.7795626846 -1.025222935 -0.552333784 -0.069185460</span>
<span class="co">#&gt; tau_int21 -1.460941641 -1.2288190408 -0.574528453 -0.141600768  0.307857378</span>
<span class="co">#&gt; tau_int22 -0.583418786 -0.3575548754  0.295103447  0.774031877  1.241263427</span>
<span class="co">#&gt; tau_int23 -1.063458063 -0.8107209709 -0.152367465  0.342204773  0.801763630</span>
<span class="co">#&gt; tau_int24 -0.438582235 -0.2262422101  0.443595723  0.944058719  1.500128741</span>
<span class="co">#&gt; tau_int25 -1.271732110 -1.1384315638 -0.661099226 -0.359774567 -0.051313753</span>
<span class="co">#&gt; tau_int26 -1.371767422 -1.1596412647 -0.500932013  0.015632330  0.556032123</span>
<span class="co">#&gt; tau_int27 -0.178759206 -0.0023950630  0.579864081  0.966318689  1.349533152</span>
<span class="co">#&gt; tau_int28 -0.399378298 -0.1881918575  0.309536113  0.692182557  1.050716016</span>
<span class="co">#&gt; tau_int29 -0.960852732 -0.7518785061 -0.133634461  0.282633746  0.726018888</span>
<span class="co">#&gt; tau_int30 -1.908764294 -1.7558865020 -1.216486541 -0.904004670 -0.538115037</span>
<span class="co">#&gt; tau_int31 -1.878407715 -1.6791309422 -1.090383853 -0.685377383 -0.302742484</span>
<span class="co">#&gt; tau_int32 -0.387604090 -0.1809773574  0.433773621  0.897003742  1.328384510</span>
<span class="co">#&gt; tau_int33 -1.330252321 -1.0893329324 -0.388286214  0.093733849  0.630615031</span>
<span class="co">#&gt; tau_int34 -2.635281775 -2.4524049582 -1.848252826 -1.426729424 -1.026996238</span>
<span class="co">#&gt; tau_int35 -1.628177966 -1.4774937009 -0.901976959 -0.544037764 -0.219172408</span>
<span class="co">#&gt; tau_int36 -1.179139284 -0.9579262152 -0.286337231  0.174336365  0.673549204</span>
<span class="co">#&gt; tau_int37 -2.133107892 -1.9091630736 -1.249226496 -0.721153109 -0.213998145</span>
<span class="co">#&gt; tau_int38 -1.145009045 -0.9163650220 -0.257272398  0.217061670  0.751133494</span>
<span class="co">#&gt; tau_int39 -2.234188677 -1.9946232843 -1.394926243 -0.973604714 -0.563068727</span>
<span class="co">#&gt; tau_int40 -1.237862007 -1.0871797802 -0.583282373 -0.205798756  0.127532037</span>
<span class="co">#&gt; tau_int41 -1.728759161 -1.5458772651 -0.923522878 -0.524679458 -0.099771699</span>
<span class="co">#&gt; tau_int42 -1.827674377 -1.6500990014 -0.945369340 -0.457197695  0.075321216</span>
<span class="co">#&gt; tau_int43 -2.125666472 -1.9756978637 -1.434400586 -1.066987712 -0.699566310</span>
<span class="co">#&gt; tau_int44 -0.641700997 -0.4176744139  0.213288824  0.669243860  1.143903634</span>
<span class="co">#&gt; tau_int45 -0.860968364 -0.7168907472 -0.176975518  0.223947675  0.627103863</span>
<span class="co">#&gt; tau_int46 -2.068707301 -1.8858197411 -1.420651383 -1.125805906 -0.839475213</span>
<span class="co">#&gt; tau_int47 -1.838230503 -1.6372762995 -0.947618743 -0.452234644  0.053097038</span>
<span class="co">#&gt; tau_int48 -2.006557177 -1.7932150631 -1.249586874 -0.857848800 -0.480553365</span>
<span class="co">#&gt; tau_int49 -1.586276340 -1.2788227629 -0.181020115  0.412006671  1.012770120</span>
<span class="co">#&gt; tau_int50 -1.868526942 -1.6403612611 -1.041058514 -0.591986926 -0.124196972</span>
<span class="co">#&gt; tau_int51 -1.414673537 -1.2047944115 -0.637409732 -0.241418049  0.118772581</span>
<span class="co">#&gt; tau_int52 -1.524252779 -1.3385755858 -0.833952136 -0.490701677 -0.177250648</span>
<span class="co">#&gt; tau_int53 -0.982125389 -0.7748609935 -0.152907972  0.317922851  0.764874785</span>
<span class="co">#&gt; tau_int54 -0.976547866 -0.6282811961  0.261400409  0.850264410  1.430040829</span>
<span class="co">#&gt; tau_int55 -2.251925625 -2.0665512904 -1.568724725 -1.225424410 -0.871840829</span>
<span class="co">#&gt; tau_int56 -0.186681800 -0.0005159711  0.635531824  1.064310153  1.505463709</span>
<span class="co">#&gt; tau_int57 -1.724211109 -1.5515948772 -1.014107398 -0.612526209 -0.191364738</span>
<span class="co">#&gt; tau_int58 -0.809790657 -0.5697412627  0.257491443  0.819069639  1.333861953</span>
<span class="co">#&gt; tau_int59 -0.299532401 -0.1486771320  0.441784509  0.856978890  1.322972925</span>
<span class="co">#&gt; tau_int60 -0.033003838  0.1242505514  0.648953959  1.029684482  1.407791079</span>
<span class="co">#&gt; xi1       -1.050250735 -0.9847866686 -0.800210179 -0.683314103 -0.567760132</span>
<span class="co">#&gt;                    95%        97.5%      rhat</span>
<span class="co">#&gt; int       -0.736993349 -0.678537663 1.0004541</span>
<span class="co">#&gt; age        0.019561221  0.021589946 1.0010114</span>
<span class="co">#&gt; age_sq    -0.003444243 -0.003249543 0.9997501</span>
<span class="co">#&gt; urban      0.899782680  0.939682207 1.0000887</span>
<span class="co">#&gt; liv2       1.104640315  1.155103021 1.0002049</span>
<span class="co">#&gt; tau_int1   2.300856448  2.458355827 1.0012160</span>
<span class="co">#&gt; tau_int2   1.286246355  1.506547434 1.0023345</span>
<span class="co">#&gt; tau_int3   1.083819772  1.421249893 1.0034416</span>
<span class="co">#&gt; tau_int4   0.559430586  0.747121338 1.0020861</span>
<span class="co">#&gt; tau_int5   0.728132377  0.918333614 1.0024308</span>
<span class="co">#&gt; tau_int6   1.384013961  1.597276525 1.0024302</span>
<span class="co">#&gt; tau_int7   1.367157952  1.598501526 1.0034692</span>
<span class="co">#&gt; tau_int8   0.667204312  0.838130638 0.9998511</span>
<span class="co">#&gt; tau_int9   1.529899759  1.750774067 1.0000151</span>
<span class="co">#&gt; tau_int10  2.031384727  2.347789299 1.0050199</span>
<span class="co">#&gt; tau_int11  2.789741638  3.057706967 1.0024999</span>
<span class="co">#&gt; tau_int12  1.205421402  1.394101889 1.0084422</span>
<span class="co">#&gt; tau_int13  0.914085404  1.112872912 1.0006066</span>
<span class="co">#&gt; tau_int14 -0.647198628 -0.502772492 1.0001665</span>
<span class="co">#&gt; tau_int15  1.166242460  1.348033598 1.0000662</span>
<span class="co">#&gt; tau_int16 -0.276377532 -0.078949558 0.9999055</span>
<span class="co">#&gt; tau_int17  1.543768713  1.758784771 1.0013887</span>
<span class="co">#&gt; tau_int18  1.020162320  1.168867106 0.9998860</span>
<span class="co">#&gt; tau_int19  0.848277220  1.036757683 1.0008222</span>
<span class="co">#&gt; tau_int20  0.582890640  0.811731648 1.0019756</span>
<span class="co">#&gt; tau_int21  0.950299716  1.146866890 0.9997681</span>
<span class="co">#&gt; tau_int22  1.923351408  2.148781431 0.9999651</span>
<span class="co">#&gt; tau_int23  1.530030399  1.768769886 1.0000140</span>
<span class="co">#&gt; tau_int24  2.181172569  2.442200531 1.0083890</span>
<span class="co">#&gt; tau_int25  0.425804684  0.584379800 0.9998763</span>
<span class="co">#&gt; tau_int26  1.296942492  1.559860633 1.0023741</span>
<span class="co">#&gt; tau_int27  1.957083373  2.169141438 1.0042869</span>
<span class="co">#&gt; tau_int28  1.561490025  1.751129841 1.0050521</span>
<span class="co">#&gt; tau_int29  1.358395414  1.588888385 1.0035890</span>
<span class="co">#&gt; tau_int30 -0.079033076  0.129943216 1.0026599</span>
<span class="co">#&gt; tau_int31  0.297356402  0.544609648 0.9997646</span>
<span class="co">#&gt; tau_int32  1.975809228  2.188732420 1.0047211</span>
<span class="co">#&gt; tau_int33  1.336256585  1.566798539 1.0044995</span>
<span class="co">#&gt; tau_int34 -0.498302111 -0.359935459 1.0001960</span>
<span class="co">#&gt; tau_int35  0.308227202  0.498301565 1.0054541</span>
<span class="co">#&gt; tau_int36  1.337924703  1.601391586 0.9997961</span>
<span class="co">#&gt; tau_int37  0.499356584  0.748483067 1.0010755</span>
<span class="co">#&gt; tau_int38  1.443993109  1.657356451 1.0029935</span>
<span class="co">#&gt; tau_int39  0.013807939  0.230378782 0.9997551</span>
<span class="co">#&gt; tau_int40  0.687934978  0.863985409 1.0005405</span>
<span class="co">#&gt; tau_int41  0.540149575  0.753051282 0.9999328</span>
<span class="co">#&gt; tau_int42  0.723847732  0.970869619 1.0000756</span>
<span class="co">#&gt; tau_int43 -0.187481543  0.051059293 1.0011655</span>
<span class="co">#&gt; tau_int44  1.808872536  2.069436250 1.0002663</span>
<span class="co">#&gt; tau_int45  1.249321834  1.481601439 1.0002866</span>
<span class="co">#&gt; tau_int46 -0.420763402 -0.292636343 0.9997541</span>
<span class="co">#&gt; tau_int47  0.809350806  1.015858066 0.9998655</span>
<span class="co">#&gt; tau_int48  0.011028672  0.151163355 1.0031805</span>
<span class="co">#&gt; tau_int49  1.905111098  2.185443413 1.0022514</span>
<span class="co">#&gt; tau_int50  0.540814707  0.714762204 1.0034785</span>
<span class="co">#&gt; tau_int51  0.686408111  0.894414330 0.9997523</span>
<span class="co">#&gt; tau_int52  0.272171243  0.436530301 1.0008694</span>
<span class="co">#&gt; tau_int53  1.540966276  1.772240803 1.0022311</span>
<span class="co">#&gt; tau_int54  2.331555684  2.539832776 1.0021673</span>
<span class="co">#&gt; tau_int55 -0.377461606 -0.179753878 1.0015752</span>
<span class="co">#&gt; tau_int56  2.176731940  2.375296343 1.0014536</span>
<span class="co">#&gt; tau_int57  0.434300402  0.649342148 0.9997597</span>
<span class="co">#&gt; tau_int58  2.072730566  2.277903499 1.0001863</span>
<span class="co">#&gt; tau_int59  1.969986316  2.154127571 1.0009052</span>
<span class="co">#&gt; tau_int60  1.975499184  2.169942672 1.0002287</span>
<span class="co">#&gt; xi1       -0.400481722 -0.369098480 1.0031928</span></pre></body></html></div>
<p>We create trace plots on the transformed simulation data.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/hmclearn-plots.html">mcmc_trace</a></span>(<span class="no">f_hmc2</span>, <span class="kw">burnin</span><span class="kw">=</span><span class="fl">1000</span>, <span class="kw">pars</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">X</span>))</pre></body></html></div>
<p><img src="logistic_mixed_effects_hmclearn_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
</div>
</div>
<div id="frequentist-model" class="section level1">
<h1 class="hasAnchor">
<a href="#frequentist-model" class="anchor"></a>Frequentist model</h1>
<p>To compare results, we first fit a logistic mixed effects model using the frequentist package <strong>lme4</strong> (Bates et. al. 2015).</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lme4</span>)
<span class="co">#&gt; Loading required package: Matrix</span>

<span class="no">f</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(<span class="no">use</span> ~ <span class="no">age</span> + <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span>(<span class="no">age</span>^<span class="fl">2</span>) + <span class="no">urban</span> + <span class="no">liv2</span> + (<span class="fl">1</span> <span class="kw">|</span> <span class="no">district</span>),
           <span class="kw">data</span><span class="kw">=</span><span class="no">Contraception</span>, <span class="kw">family</span><span class="kw">=</span><span class="no">binomial</span>,
           <span class="kw">control</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html">glmerControl</a></span>(<span class="kw">optCtrl</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">maxfun</span><span class="kw">=</span><span class="fl">20000</span>)))
<span class="co">#&gt; Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, : Model is nearly unidentifiable: very large eigenvalue</span>
<span class="co">#&gt;  - Rescale variables?</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">f</span>)
<span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span>
<span class="co">#&gt;   Approximation) [glmerMod]</span>
<span class="co">#&gt;  Family: binomial  ( logit )</span>
<span class="co">#&gt; Formula: use ~ age + I(age^2) + urban + liv2 + (1 | district)</span>
<span class="co">#&gt;    Data: Contraception</span>
<span class="co">#&gt; Control: glmerControl(optCtrl = list(maxfun = 20000))</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span>
<span class="co">#&gt;   2385.2   2418.6  -1186.6   2373.2     1928 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Scaled residuals: </span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -1.8151 -0.7620 -0.4619  0.9518  3.1033 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span>
<span class="co">#&gt;  district (Intercept) 0.2247   0.474   </span>
<span class="co">#&gt; Number of obs: 1934, groups:  district, 60</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="co">#&gt; (Intercept) -1.0063737  0.1691107  -5.951 2.67e-09 ***</span>
<span class="co">#&gt; age          0.0062561  0.0078848   0.793    0.428    </span>
<span class="co">#&gt; I(age^2)    -0.0046353  0.0007207  -6.432 1.26e-10 ***</span>
<span class="co">#&gt; urbanY       0.6929220  0.1206566   5.743 9.31e-09 ***</span>
<span class="co">#&gt; liv2         0.8603821  0.1483014   5.802 6.57e-09 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Correlation of Fixed Effects:</span>
<span class="co">#&gt;          (Intr) age    I(g^2) urbanY</span>
<span class="co">#&gt; age       0.529                     </span>
<span class="co">#&gt; I(age^2) -0.533 -0.506              </span>
<span class="co">#&gt; urbanY   -0.259 -0.032  0.020       </span>
<span class="co">#&gt; liv2     -0.801 -0.565  0.345  0.094</span>
<span class="co">#&gt; convergence code: 0</span>
<span class="co">#&gt; Model is nearly unidentifiable: very large eigenvalue</span>
<span class="co">#&gt;  - Rescale variables?</span></pre></body></html></div>
<div class="sourceCode" id="cb11"><html><body><pre class="r">
<span class="no">freqvals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/lme4/man/fixef.html">fixef</a></span>(<span class="no">f</span>)),
              <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/lme4/man/ranef.html">ranef</a></span>(<span class="no">f</span>)$<span class="no">district</span>[, <span class="fl">1</span>]),
              <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/lme4/man/VarCorr.html">VarCorr</a></span>(<span class="no">f</span>)[<span class="fl">1</span>]))))</pre></body></html></div>
<p>Histograms of the posterior distribution show that Bayesian parameter estimates align with frequentist estimates. The <em>cols</em> parameter specifies the parameters to be displayed in <em>diagplots</em>, based on the order provided to the <em>hmc</em> function.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="../reference/diagplots.html">diagplots</a></span>(<span class="no">f_hmc2</span>, <span class="kw">burnin</span><span class="kw">=</span><span class="fl">1000</span>,
          <span class="kw">comparison.theta</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">freqvals</span>[<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>)], <span class="no">freqvals</span>[<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">freqvals</span>)]),
          <span class="kw">cols</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">initvals</span>)))
<span class="co">#&gt; $histogram</span></pre></body></html></div>
<p><img src="logistic_mixed_effects_hmclearn_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
</div>
<div id="source" class="section level1">
<h1 class="hasAnchor">
<a href="#source" class="anchor"></a>Source</h1>
<p>Steele, F., Diamond, I. And Amin, S. (1996). Immunization uptake in rural Bangladesh: a multilevel analysis. <em>Journal of the Royal Statistical Society</em>, Series A (159): 289-299.</p>
<p></p>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<p>Bates, D., M"{a}chler, M., Bolker, B., &amp; Walker, S. (2015). Fitting linear mixed-effects models using lme4. <em>Journal of Statistical Software</em> 67(1)</p>
<p>Bates, D., M"{a}chler, M., &amp; Bolker, B. (2014). mlmRev: Examples from multilevel modelling software review. <em>R package version, 1</em>.</p>
<p>Agresti, A. (2015). <em>Foundations of linear and generalized linear models</em>. John Wiley &amp; Sons. ISBN: 978-1-118-73003-4</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Samuel Thomas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
